<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TaskFlow">
    <meta name="theme-color" content="#3B82F6">
    
    <!-- Permissions Policyå¯¾å¿œ -->
    <meta http-equiv="Permissions-Policy" content="browsing-topics=()">
    
    <!-- PWAç”¨ã®ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%233B82F6'/><path d='M40 90L70 120L140 50' stroke='white' stroke-width='8' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>">
    <link rel="manifest" href="manifest.json">
    
    <title>TaskFlow Pro - å®Œå…¨ç‰ˆ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, getDocs, onSnapshot, collection, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        window.FirebaseSDK = { initializeApp, getFirestore, doc, setDoc, getDoc, getDocs, onSnapshot, collection, query, orderBy, limit, getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult, signOut };
    </script>
    
    <!-- Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* iOSé¢¨ã®ãƒœã‚¿ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .ios-tap {
            transition: all 0.1s ease;
        }
        
        .ios-tap:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ï¼ˆiOSé¢¨ï¼‰ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 2px;
        }
        
        /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒ‘ãƒ«ã‚¹åŠ¹æœ */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        .pulse-effect {
            animation: pulse 2s infinite;
        }
        
        /* æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        input[type="date"]::-webkit-calendar-picker-indicator {
            opacity: 0.6;
        }
        
        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        .custom-checkbox {
            appearance: none;
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .custom-checkbox:checked {
            background: #3B82F6;
            border-color: #3B82F6;
        }
        
        .custom-checkbox:checked::after {
            content: 'âœ“';
            color: white;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        /* ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ« */
        .tab-button.active {
            border-bottom-color: #3B82F6 !important;
            color: #3B82F6 !important;
        }
        
        /* æ™‚é–“è¨ˆæ¸¬ãƒœã‚¿ãƒ³ */
        .timer-btn {
            transition: all 0.2s ease;
        }
        
        .timer-btn.running {
            background: #EF4444;
            color: white;
            animation: pulse-red 2s infinite;
        }
        
        .timer-btn.running:hover {
            background: #DC2626;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .gantt-container {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            height: 600px;
            overflow: hidden;
            z-index: 1;
        }
        
        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
        #gantt-filter-client,
        #gantt-filter-status {
            position: relative !important;
            z-index: 50 !important;
            background-color: white !important;
            pointer-events: auto !important;
            -webkit-appearance: menulist !important;
            appearance: menulist !important;
        }
        
        #gantt-filter-client:focus,
        #gantt-filter-status:focus {
            z-index: 100 !important;
        }
        
        /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .gantt-filters {
            position: relative;
            z-index: 25;
        }
        
        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
        #gantt-filter-client:hover,
        #gantt-filter-status:hover {
            border-color: #3b82f6 !important;
            cursor: pointer !important;
        }
        
        .gantt-task-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .gantt-task-row:hover {
            background-color: #f3f4f6;
        }
        
        .gantt-subtask {
            padding-left: 20px;
            font-size: 11px;
            color: #6b7280;
            border-left: 2px solid #e5e7eb;
            margin-left: 10px;
        }
        
        .gantt-subtask-bar {
            height: 16px;
            background: #9CA3AF;
            border-radius: 2px;
            font-size: 10px;
            padding: 0 4px;
            margin: 1px 0;
        }
        
        .gantt-subtask-bar.completed {
            background: #6EE7B7;
        }
        
        .gantt-wrapper {
            display: flex;
            height: 100%;
        }
        
        .gantt-fixed-column {
            width: 320px;
            background: white;
            border-right: 2px solid #d1d5db;
            z-index: 20;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
            overflow-y: auto;
            flex-shrink: 0;
        }
        
        /* ãƒ¢ãƒã‚¤ãƒ«è¡¨ç¤ºã®æœ€é©åŒ– */
        @media screen and (max-width: 640px) {
            .gantt-fixed-column {
                width: 160px !important;
            }
        }
        
        @media screen and (max-width: 768px) {
            .gantt-fixed-column {
                width: 200px !important;
            }
        }
        
        /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®æ”¹å–„ */
        .tab-button {
            transition: all 0.2s ease;
            border-radius: 8px 8px 0 0;
            position: relative;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        
        /* ãƒœã‚¿ãƒ³å†…ã®è¦ç´ ãŒã‚¯ãƒªãƒƒã‚¯ã‚’é˜»å®³ã—ãªã„ã‚ˆã†ã« */
        .tab-button * {
            pointer-events: none;
        }
        
        /* ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯é ˜åŸŸã‚’ç¢ºå®Ÿã«è¨­å®š */
        .tab-button {
            position: relative;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
        }
        
        .tab-button:active {
            transform: scale(0.95);
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .tab-button.active {
            background-color: rgba(59, 130, 246, 0.05);
            border-bottom-width: 3px !important;
        }
        
        @media screen and (max-width: 640px) {
            .tab-button {
                min-width: 60px;
                border-radius: 6px;
                min-height: 60px; /* ã•ã‚‰ã«ã‚¿ãƒƒãƒã—ã‚„ã™ã */
            }
            
            .tab-button.active {
                background-color: rgba(59, 130, 246, 0.1);
                border-bottom-width: 3px !important;
            }
        }
        
        /* ğŸ”„ åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sync-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .sync-status.success {
            background-color: rgba(34, 197, 94, 0.2);
            animation: pulse-success 2s ease-in-out;
        }
        
        .sync-status.error {
            background-color: rgba(239, 68, 68, 0.2);
            animation: pulse-error 2s ease-in-out;
        }
        
        .sync-status.syncing {
            animation: spin 1s linear infinite;
        }
        
        @keyframes pulse-success {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes pulse-error {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .gantt-scrollable-area {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        .gantt-content {
            display: flex;
            flex-direction: column;
            min-height: 100%;
        }
        
        .gantt-row {
            height: 80px;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
        }
        
        .gantt-header {
            height: 80px;
            background: #f9fafb;
            border-bottom: 2px solid #d1d5db;
            display: flex;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .gantt-task-bar {
            height: 24px;
            background: #3B82F6;
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 8px;
            color: white;
            font-weight: 500;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
            position: relative;
            margin: 2px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .gantt-task-bar:hover {
            background: #2563EB;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .gantt-task-bar.completed {
            background: #10B981;
            opacity: 0.8;
        }
        
        .gantt-task-bar.completed:hover {
            background: #059669;
        }
        
        .gantt-task-bar.high-priority {
            background: #EF4444;
        }
        
        .gantt-task-bar.high-priority:hover {
            background: #DC2626;
        }
        
        .gantt-day-column {
            min-width: 50px;
            width: 50px;
            height: 100%;
            border-right: 1px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: #6b7280;
            flex-shrink: 0;
            padding: 2px;
        }
        
        .gantt-weekend {
            background: #f9fafb;
        }
        
        .gantt-today {
            background: #fef3c7;
            border-right: 2px solid #f59e0b;
        }
        
        /* ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã‚¹ã‚¿ã‚¤ãƒ« */
        input[type="checkbox"]:checked + div {
            background-color: #10b981;
        }
        
        input[type="checkbox"]:checked + div .dot {
            transform: translateX(24px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-30">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center flex-shrink-0">
                        <i class="fas fa-tasks text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-xl font-bold text-gray-900">TaskFlow Pro</h1>
                    </div>
                    
                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div class="flex justify-center flex-1 max-w-md mx-auto">
                        <div class="grid grid-cols-5 w-full gap-1 sm:gap-4">
                            <button class="tab-button border-b-2 border-transparent p-3 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 active flex flex-col items-center justify-center min-h-[48px]" data-tab="tasks" style="touch-action: manipulation;">
                                <i class="fas fa-list text-lg mb-1"></i>
                                <span class="text-xs leading-none">ã‚¿ã‚¹ã‚¯</span>
                            </button>
                            <button class="tab-button border-b-2 border-transparent p-3 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex flex-col items-center justify-center min-h-[48px]" data-tab="gantt" style="touch-action: manipulation;">
                                <i class="fas fa-chart-gantt text-lg mb-1"></i>
                                <span class="text-xs leading-none">ã‚¬ãƒ³ãƒˆ</span>
                            </button>
                            <button class="tab-button border-b-2 border-transparent p-3 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex flex-col items-center justify-center min-h-[48px]" data-tab="clients" style="touch-action: manipulation;">
                                <i class="fas fa-users text-lg mb-1"></i>
                                <span class="text-xs leading-none">é¡§å®¢</span>
                            </button>
                            <button class="tab-button border-b-2 border-transparent p-3 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex flex-col items-center justify-center min-h-[48px]" data-tab="reports" style="touch-action: manipulation;">
                                <i class="fas fa-chart-bar text-lg mb-1"></i>
                                <span class="text-xs leading-none">ãƒ¬ãƒãƒ¼ãƒˆ</span>
                            </button>
                            <button class="tab-button border-b-2 border-transparent p-3 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 flex flex-col items-center justify-center min-h-[48px]" data-tab="settings" style="touch-action: manipulation;">
                                <i class="fas fa-cog text-lg mb-1"></i>
                                <span class="text-xs leading-none">è¨­å®š</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ã‚¿ã‚¹ã‚¯ç®¡ç†ç”»é¢ -->
        <div id="tasks-view" class="tab-content">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢ã‚¨ãƒªã‚¢ -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="search-input" placeholder="ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex gap-2">
                            <select id="filter-status" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                                <option value="pending">æœªç€æ‰‹</option>
                                <option value="in_progress">é€²è¡Œä¸­</option>
                                <option value="completed">å®Œäº†</option>
                            </select>
                            <select id="filter-priority" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="">å…¨å„ªå…ˆåº¦</option>
                                <option value="high">é«˜</option>
                                <option value="medium">ä¸­</option>
                                <option value="low">ä½</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ -->
                <div id="tasks-container" class="space-y-4">
                    <!-- ã‚¿ã‚¹ã‚¯ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>

            <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
            <button id="add-task-btn" class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg ios-tap pulse-effect z-20">
                <i class="fas fa-plus text-xl"></i>
            </button>
        </div>

        <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆç”»é¢ -->
        <div id="gantt-view" class="tab-content hidden">
            <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <div class="flex flex-col gap-4 mb-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-semibold text-gray-900">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h2>
                            <div class="flex items-center gap-2">
                                <button id="gantt-prev-month" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">
                                    <i class="fas fa-chevron-left"></i> å‰æœˆ
                                </button>
                                <button id="gantt-today-month" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-md text-sm">
                                    <i class="fas fa-calendar-day mr-1"></i>ä»Šæœˆ
                                </button>
                                <span id="gantt-current-month" class="text-lg font-medium text-gray-700 mx-2"></span>
                                <button id="gantt-next-month" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded-md text-sm">
                                    æ¬¡æœˆ <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div class="gantt-filters flex flex-col sm:flex-row gap-4 items-start sm:items-center relative z-10">
                            <div class="flex-1 w-full">
                                <input type="text" id="gantt-search-input" placeholder="ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆå†…ã§ã‚¿ã‚¹ã‚¯ã‚’æ¤œç´¢..." 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <select id="gantt-filter-client" 
                                        class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer min-w-[120px] relative z-20">
                                    <option value="">å…¨é¡§å®¢</option>
                                </select>
                                <select id="gantt-filter-status" 
                                        class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white cursor-pointer min-w-[100px] relative z-20">
                                    <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                                    <option value="pending">æœªç€æ‰‹</option>
                                    <option value="in_progress">é€²è¡Œä¸­</option>
                                    <option value="completed">å®Œäº†</option>
                                </select>
                            </div>
                            <label class="flex items-center text-sm text-gray-600 whitespace-nowrap">
                                <input type="checkbox" id="gantt-show-subtasks" class="mr-2 rounded" checked>
                                ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¡¨ç¤º
                            </label>
                        </div>
                    </div>
                    
                    <div id="gantt-container" class="gantt-container">
                        <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- é¡§å®¢ç®¡ç†ç”»é¢ -->
        <div id="clients-view" class="tab-content hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">é¡§å®¢ç®¡ç†</h2>
                    <button id="add-client-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 ios-tap">
                        <i class="fas fa-plus"></i>æ–°è¦é¡§å®¢
                    </button>
                </div>

                <div id="clients-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- é¡§å®¢ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒãƒ¼ãƒˆç”»é¢ -->
        <div id="reports-view" class="tab-content hidden">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">ãƒ¬ãƒãƒ¼ãƒˆãƒ»åˆ†æ</h2>
                
                <!-- çµ±è¨ˆã‚µãƒãƒªãƒ¼ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-tasks text-blue-600 text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">ç·ã‚¿ã‚¹ã‚¯æ•°</p>
                                <p id="total-tasks" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">å®Œäº†ã‚¿ã‚¹ã‚¯</p>
                                <p id="completed-tasks" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clock text-orange-600 text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">ç·ä½œæ¥­æ™‚é–“</p>
                                <p id="total-hours" class="text-2xl font-semibold text-gray-900">0h</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-users text-purple-600 text-2xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">é¡§å®¢æ•°</p>
                                <p id="total-clients" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ†å¸ƒ</h3>
                        <div style="height: 300px;">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">å„ªå…ˆåº¦åˆ¥ã‚¿ã‚¹ã‚¯</h3>
                        <div style="height: 300px;">
                            <canvas id="priority-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">æœˆåˆ¥ä½œæ¥­æ™‚é–“æ¨ç§»</h3>
                    <div style="height: 400px;">
                        <canvas id="monthly-hours-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¨­å®šç”»é¢ -->
        <div id="settings-view" class="tab-content hidden">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">è¨­å®š</h2>
                
                <!-- ğŸ”¥ Firebase ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸè¨­å®š -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-cloud mr-2 text-orange-600"></i>
                        Firebase ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
                        <span id="firebase-status" class="sync-status ml-2">ğŸŸ¡</span>
                    </h3>
                    <div class="space-y-4">
                        <!-- Googleèªè¨¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <label class="text-sm font-medium text-blue-800">ğŸ” Googleèªè¨¼</label>
                                    <p class="text-sm text-blue-600">å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿åŒæœŸ</p>
                                </div>
                                <div id="google-auth-status" class="text-2xl">ğŸ”´</div>
                            </div>
                            <div id="google-user-info" class="hidden mb-3">
                                <div class="flex items-center space-x-3">
                                    <img id="user-photo" class="w-8 h-8 rounded-full" alt="User">
                                    <div>
                                        <div id="user-name" class="text-sm font-medium"></div>
                                        <div id="user-email" class="text-xs text-gray-600"></div>
                                    </div>
                                </div>
                            </div>
                            <button id="google-signin-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fab fa-google mr-2"></i>Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                            </button>
                            <button id="google-signout-btn" class="hidden w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm mt-2">
                                <i class="fas fa-sign-out-alt mr-2"></i>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700">FirebaseåŒæœŸ</label>
                                <p class="text-sm text-gray-500">Googleèªè¨¼å¾Œã«è‡ªå‹•æœ‰åŠ¹åŒ–</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="firebase-sync-toggle" class="sr-only" disabled>
                                <div class="w-11 h-6 bg-gray-200 rounded-full relative">
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                        
                        <!-- Firebaseè¨­å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                        <div id="firebase-config" class="hidden space-y-4 mt-4 p-4 bg-gray-50 rounded-lg">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Firebase API Key</label>
                                <input type="text" id="firebase-api-key" placeholder="AIzaSyC..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <p class="text-xs text-gray-500 mt-1">Firebase Console â†’ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š â†’ ã‚¦ã‚§ãƒ–APIã‚­ãƒ¼</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Project ID</label>
                                <input type="text" id="firebase-project-id" placeholder="taskflow-pro-xxxxx" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                            </div>
                            <div class="flex space-x-2">
                                <button id="firebase-test-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-md text-sm">
                                    <i class="fas fa-plug mr-1"></i>æ¥ç¶šãƒ†ã‚¹ãƒˆ
                                </button>
                                <button id="firebase-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                    <i class="fas fa-save mr-1"></i>è¨­å®šä¿å­˜
                                </button>
                            </div>
                            <div class="mt-2 space-y-2">
                                <button id="firebase-manual-sync-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm w-full">
                                    <i class="fas fa-sync mr-1"></i>æ‰‹å‹•åŒæœŸå®Ÿè¡Œ
                                </button>
                                <button id="firebase-search-existing-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm w-full">
                                    <i class="fas fa-search mr-1"></i>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»å–å¾—
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
                            <div class="flex items-start">
                                <i class="fas fa-info-circle text-blue-600 mr-2 mt-0.5"></i>
                                <div class="text-sm text-blue-800">
                                    <p><strong>åŒæœŸæ©Ÿèƒ½ã®ç‰¹å¾´ï¼š</strong></p>
                                    <ul class="list-disc list-inside mt-1 space-y-1">
                                        <li>ğŸ“± iPhoneãƒ»iPadãƒ»PCé–“ã§è‡ªå‹•ãƒ‡ãƒ¼ã‚¿åŒæœŸ</li>
                                        <li>ğŸ”„ 30ç§’ã”ã¨ã®è‡ªå‹•æ›´æ–°</li>
                                        <li>ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ + ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</li>
                                        <li>ğŸ†“ å®Œå…¨ç„¡æ–™ï¼ˆè¿½åŠ ã‚³ã‚¹ãƒˆãªã—ï¼‰</li>
                                        <li>ğŸ›¡ï¸ ç«¶åˆè§£æ±ºæ©Ÿèƒ½å†…è”µ</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div id="sync-mode-display" class="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded">
                            <span id="sync-mode-text">åŒæœŸãƒ¢ãƒ¼ãƒ‰ç¢ºèªä¸­...</span>
                        </div>
                        
                        <!-- ğŸ”„ æ‰‹å‹•åŒæœŸã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <h4 class="font-semibold text-yellow-800 mb-2">
                                <i class="fas fa-exchange-alt mr-2"></i>æ‰‹å‹•ç«¯æœ«é–“åŒæœŸ
                            </h4>
                            <p class="text-sm text-yellow-700 mb-3">
                                è‡ªå‹•åŒæœŸãŒåˆ©ç”¨ã§ããªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µ
                            </p>
                            <div class="space-y-2">
                                <button id="generate-sync-qr" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-2 rounded text-sm">
                                    ğŸ“± QRã‚³ãƒ¼ãƒ‰ã§åŒæœŸï¼ˆå®Ÿè£…äºˆå®šï¼‰
                                </button>
                                <div class="text-xs text-yellow-600">
                                    ğŸ’¡ ç¾åœ¨ï¼šè¨­å®š â†’ ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ ã§æ‰‹å‹•åŒæœŸå¯èƒ½
                                </div>
                            </div>
                        </div>
                        
                        <div id="sync-status-info" class="text-sm text-gray-600">
                            <div class="flex items-center justify-between">
                                <span>æœ€çµ‚åŒæœŸ:</span>
                                <span id="last-sync-time">æœªåŒæœŸ</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Google Calendarçµ±åˆ -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Google Calendarçµ±åˆ</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸ</label>
                                <p class="text-sm text-gray-500">ã‚¿ã‚¹ã‚¯ã®æœŸé™ã‚’Google Calendarã¨åŒæœŸã—ã¾ã™</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="calendar-sync-toggle" class="sr-only">
                                <div class="w-11 h-6 bg-gray-200 rounded-full relative">
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                        
                        <div id="calendar-settings" class="hidden space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Calendar API Key</label>
                                <input type="text" id="google-api-key" placeholder="AIzaSyC..." 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-1">Google Cloud Consoleã§Calendar APIã‚’æœ‰åŠ¹åŒ–ã—ã€APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Client ID</label>
                                <input type="text" id="google-client-id" placeholder="123456789-abc...apps.googleusercontent.com" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-1">OAuth 2.0èªè¨¼ç”¨ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Calendar ID</label>
                                <input type="text" id="calendar-id" placeholder="primary ã¾ãŸã¯ specific-calendar@gmail.com" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <p class="text-xs text-gray-500 mt-1">ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯ã€Œprimaryã€ã€ç‰¹å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å ´åˆã¯ãã®IDã‚’å…¥åŠ›</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="google-auth-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                                    <i class="fab fa-google mr-2"></i>Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                                </button>
                                <button id="test-calendar-connection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                    æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆ
                                </button>
                                <button id="sync-tasks-to-calendar" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm" disabled>
                                    ã‚¿ã‚¹ã‚¯ã‚’åŒæœŸ
                                </button>
                            </div>
                            <div id="calendar-status" class="text-sm"></div>
                        </div>
                    </div>
                </div>

                <!-- é€šçŸ¥è¨­å®š -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">é€šçŸ¥è¨­å®š</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-sm font-medium text-gray-700">ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥</label>
                                <p class="text-sm text-gray-500">æœŸé™ãŒè¿‘ã¥ã„ãŸã‚¿ã‚¹ã‚¯ã‚’é€šçŸ¥ã—ã¾ã™</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="desktop-notifications-toggle" class="sr-only">
                                <div class="w-11 h-6 bg-gray-200 rounded-full relative">
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <button id="export-data-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-download mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                            </button>
                            <button id="import-data-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-upload mr-2"></i>ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå·®åˆ†è¿½åŠ å¯¾å¿œï¼‰
                            </button>
                            <button id="clear-data-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                                <i class="fas fa-trash mr-2"></i>å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                        <input type="file" id="import-file-input" accept=".json" class="hidden">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¿ã‚¹ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900">æ–°ã—ã„ã‚¿ã‚¹ã‚¯</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="task-form" class="p-6 space-y-4">
                <input type="hidden" id="task-id">
                
                <div>
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">ã‚¿ã‚¹ã‚¯å *</label>
                    <input type="text" id="task-title" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-deadline" class="block text-sm font-medium text-gray-700 mb-1">æœŸé™ *</label>
                        <input type="date" id="task-deadline" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">å„ªå…ˆåº¦</label>
                        <select id="task-priority"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="low">ä½</option>
                            <option value="medium" selected>ä¸­</option>
                            <option value="high">é«˜</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="task-scheduled" class="block text-sm font-medium text-gray-700 mb-1">äºˆå®šé–‹å§‹æ—¥æ™‚</label>
                        <input type="datetime-local" id="task-scheduled"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="task-client" class="block text-sm font-medium text-gray-700 mb-1">é¡§å®¢</label>
                        <select id="task-client"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">é¡§å®¢ã‚’é¸æŠ</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="task-estimated-hours" class="block text-sm font-medium text-gray-700 mb-1">äºˆæƒ³ä½œæ¥­æ™‚é–“ï¼ˆæ™‚ï¼‰</label>
                    <input type="number" id="task-estimated-hours" step="0.5" min="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">èª¬æ˜</label>
                    <textarea id="task-description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <!-- ã‚µãƒ–ã‚¿ã‚¹ã‚¯ -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-700">ã‚µãƒ–ã‚¿ã‚¹ã‚¯</label>
                        <button type="button" id="add-subtask-btn" class="text-blue-600 hover:text-blue-700 text-sm">
                            <i class="fas fa-plus mr-1"></i>ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
                        </button>
                    </div>
                    <div id="subtasks-container"></div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-btn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- é¡§å®¢ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="flex justify-between items-center p-6 border-b">
                <h3 id="client-modal-title" class="text-lg font-semibold text-gray-900">æ–°ã—ã„é¡§å®¢</h3>
                <button id="close-client-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="client-form" class="p-6 space-y-4">
                <input type="hidden" id="client-id">
                
                <div>
                    <label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ *</label>
                    <input type="text" id="client-name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="client-company" class="block text-sm font-medium text-gray-700 mb-1">æ‹…å½“è€…</label>
                    <input type="text" id="client-company"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="client-email" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="client-email"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="client-phone" class="block text-sm font-medium text-gray-700 mb-1">é›»è©±ç•ªå·</label>
                    <input type="tel" id="client-phone"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                
                <div>
                    <label for="client-notes" class="block text-sm font-medium text-gray-700 mb-1">ãƒ¡ãƒ¢</label>
                    <textarea id="client-notes" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" id="cancel-client-btn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        ä¿å­˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class TaskFlowApp {
            constructor() {
                this.tasks = JSON.parse(localStorage.getItem('taskflow_tasks') || '[]');
                this.clients = JSON.parse(localStorage.getItem('taskflow_clients') || '[]');
                this.subtasks = JSON.parse(localStorage.getItem('taskflow_subtasks') || '[]');
                this.timeLogs = JSON.parse(localStorage.getItem('taskflow_time_logs') || '[]');
                this.settings = JSON.parse(localStorage.getItem('taskflow_settings') || '{}');
                
                this.currentEditingTask = null;
                this.currentEditingClient = null;
                this.currentTab = 'tasks';
                this.ganttCurrentDate = new Date();
                
                // Google Calendar APIè¨­å®š
                this.googleCalendarApiKey = null;
                this.googleAccessToken = null;
                this.isGoogleCalendarInitialized = false;
                
                // ğŸ”¥ FirebaseåŒæœŸè¨­å®š
                this.firebaseEnabled = this.settings.firebaseEnabled || false;
                this.firebaseConfig = this.settings.firebaseConfig || null;
                this.firebaseApp = null;
                this.firestore = null;
                this.auth = null;
                this.user = null;
                this.lastSyncTime = this.settings.lastSyncTime || 0;
                this.syncInProgress = false;
                this.unsubscribeFirestore = null;
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.switchTab('tasks');
                this.renderTasks();
                this.loadSettings();
                this.startTimerUpdates();
                
                // ğŸ”¥ FirebaseåˆæœŸåŒ–
                if (this.firebaseEnabled && this.firebaseConfig) {
                    setTimeout(() => this.initializeFirebase(), 1000);
                }
                
                // ãƒ‡ãƒãƒƒã‚°: åˆæœŸãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ³ã‚’ãƒ­ã‚°å‡ºåŠ›
                console.log('ğŸš€ TaskFlow Pro åˆæœŸåŒ–å®Œäº†');
                console.log(`ğŸ“ é¡§å®¢æ•°: ${this.clients.length}`);
                console.log(`ğŸ“ ã‚¿ã‚¹ã‚¯æ•°: ${this.tasks.length}`);
                
                if (this.clients.length === 0) {
                    console.log('âš ï¸ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšé¡§å®¢ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
                }
            }
            
            // ğŸ”¥ FirebaseåŒæœŸæ©Ÿèƒ½
            async initializeFirebase() {
                try {
                    // Firebase SDK å®Œå…¨èª­ã¿è¾¼ã¿ç¢ºèª
                    if (!window.FirebaseSDK) {
                        console.error('âŒ Firebase SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        setTimeout(() => this.initializeFirebase(), 2000); // 2ç§’å¾Œã«å†è©¦è¡Œ
                        return;
                    }
                    
                    if (!this.firebaseConfig) {
                        console.error('âŒ Firebaseè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        this.updateFirebaseStatus('error');
                        return;
                    }
                    
                    console.log('ğŸ”¥ FirebaseåˆæœŸåŒ–é–‹å§‹...', {
                        sdkLoaded: !!window.FirebaseSDK,
                        configExists: !!this.firebaseConfig,
                        domain: window.location.hostname
                    });
                    
                    const { initializeApp, getFirestore, getAuth, signInAnonymously, onAuthStateChanged } = window.FirebaseSDK;
                    
                    // FirebaseåˆæœŸåŒ–ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œç‰ˆï¼‰
                    const adjustedConfig = {
                        ...this.firebaseConfig,
                        authDomain: this.firebaseConfig.authDomain || `${this.firebaseConfig.projectId}.firebaseapp.com`
                    };
                    
                    console.log('ğŸ”§ Firebaseè¨­å®š:', {
                        projectId: adjustedConfig.projectId,
                        authDomain: adjustedConfig.authDomain,
                        currentDomain: window.location.hostname
                    });
                    
                    this.firebaseApp = initializeApp(adjustedConfig);
                    this.firestore = getFirestore(this.firebaseApp);
                    this.auth = getAuth(this.firebaseApp);
                    
                    // åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼å¯¾ç­–: ã‚ªãƒ•ãƒ©ã‚¤ãƒ³æ°¸ç¶šåŒ–ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                    try {
                        const { enableNetwork, disableNetwork } = window.FirebaseSDK;
                        console.log('ğŸ”§ Firebaseè¨­å®šæœ€é©åŒ–ä¸­...');
                    } catch (error) {
                        console.log('âš ï¸ ä¸€éƒ¨ã®Firebaseæ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¦ã„ã¾ã™');
                    }
                    
                    // ğŸ” Googleèªè¨¼æ–¹å¼ï¼ˆå®‰å…¨ï¼†åŒæœŸå•é¡Œè§£æ±ºï¼‰
                    onAuthStateChanged(this.auth, (user) => {
                        if (user && user.providerData[0]?.providerId === 'google.com') {
                            // Googleèªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
                            this.user = user;
                            console.log('âœ… Googleèªè¨¼æˆåŠŸ:', {
                                uid: user.uid,
                                email: user.email,
                                name: user.displayName,
                                provider: 'Google'
                            });
                            
                            this.startFirebaseSync();
                            this.updateFirebaseStatus('success');
                            
                        } else if (user && user.isAnonymous) {
                            // åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’Googleã«å¤‰æ›
                            console.log('âš ï¸ åŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡º - Googleèªè¨¼ã‚’æ¨å¥¨');
                            this.showGoogleAuthPrompt();
                            
                        } else {
                            // æœªèªè¨¼çŠ¶æ…‹
                            console.log('ğŸ” èªè¨¼ãŒå¿…è¦ã§ã™');
                            this.showGoogleAuthPrompt();
                            this.updateFirebaseStatus('error');
                        }
                    });
                    
                } catch (error) {
                    console.error('âŒ FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateFirebaseStatus('error');
                }
            }
            
            async startFirebaseSync() {
                if (!this.firestore || !this.user) {
                    console.error('âŒ FirebaseåŒæœŸé–‹å§‹å¤±æ•—:', {
                        firestore: !!this.firestore,
                        user: !!this.user
                    });
                    return;
                }
                
                try {
                    const { doc, onSnapshot, getDoc } = window.FirebaseSDK;
                    
                    // äº‹å‰æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    console.log('ğŸ” Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
                    const userDocRef = doc(this.firestore, 'users', this.user.uid);
                    
                    // ã¾ãšä¸€åº¦èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
                    const testDoc = await getDoc(userDocRef);
                    console.log('âœ… èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆæˆåŠŸ:', {
                        exists: testDoc.exists(),
                        userId: this.user.uid,
                        permissions: 'OK'
                    });
                    
                    // ğŸš¨ èµ·å‹•æ™‚å¼·åˆ¶åŒæœŸ: Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å¿…ãšå–å¾—
                    if (testDoc.exists()) {
                        const initialData = testDoc.data();
                        console.log('ğŸš€ èµ·å‹•æ™‚ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹ - å¼·åˆ¶å–å¾—å®Ÿè¡Œ');
                        console.log('ğŸ“Š ç™ºè¦‹ãƒ‡ãƒ¼ã‚¿:', {
                            tasks: initialData.tasks?.length || 0,
                            clients: initialData.clients?.length || 0,
                            timestamp: new Date(initialData.lastModified).toLocaleString()
                        });
                        
                        // ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚ˆã‚ŠFirebaseãŒæ–°ã—ã„ã€ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ãŒç©ºã®å ´åˆ
                        const localEmpty = (this.tasks?.length || 0) === 0 && (this.clients?.length || 0) === 0;
                        const firebaseNewer = initialData.lastModified > (this.lastSyncTime || 0);
                        
                        if (localEmpty || firebaseNewer) {
                            console.log('ğŸ’‰ èµ·å‹•æ™‚å¼·åˆ¶åŒæœŸå®Ÿè¡Œ');
                            this.mergeFirebaseData(initialData);
                        }
                    } else {
                        console.log('ğŸ“„ Firebaseåˆå›èµ·å‹• - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰äºˆå®š');
                    }
                    
                    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼è¨­å®š
                    
                    this.unsubscribeFirestore = onSnapshot(userDocRef, (docSnapshot) => {
                        try {
                            if (docSnapshot.exists()) {
                                const data = docSnapshot.data();
                                console.log('ğŸ”„ Firebaseã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å—ä¿¡:', {
                                    lastModified: data.lastModified,
                                    localLastSync: this.lastSyncTime,
                                    syncInProgress: this.syncInProgress,
                                    shouldMerge: data.lastModified !== this.lastSyncTime
                                });
                                
                                // ã‚ˆã‚Šæ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã€ã¾ãŸã¯åˆå›åŒæœŸã®å ´åˆã¯æ›´æ–°
                                const isNewer = data.lastModified > (this.lastSyncTime || 0);
                                const isInitialSync = !this.lastSyncTime;
                                const shouldSync = (isNewer || isInitialSync) && !this.syncInProgress;
                                
                                console.log('ğŸ” åŒæœŸåˆ¤å®šè©³ç´°:', {
                                    firebaseTimestamp: data.lastModified,
                                    localTimestamp: this.lastSyncTime,
                                    isNewer,
                                    isInitialSync,
                                    shouldSync,
                                    syncInProgress: this.syncInProgress
                                });
                                
                                if (shouldSync) {
                                    console.log('ğŸ“¥ æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡º - ãƒãƒ¼ã‚¸é–‹å§‹');
                                    this.mergeFirebaseData(data);
                                } else {
                                    console.log('â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ç†ç”±:', {
                                        reason: !isNewer && !isInitialSync ? 'å¤ã„ãƒ‡ãƒ¼ã‚¿' : 'syncé€²è¡Œä¸­'
                                    });
                                }
                            } else {
                                console.log('ğŸ“„ Firestoreã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                            }
                        } catch (error) {
                            console.error('âŒ onSnapshot ã‚¨ãƒ©ãƒ¼:', error);
                            this.updateFirebaseStatus('error');
                        }
                    }, (error) => {
                        // åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼ˆåŒæœŸã¯æ­£å¸¸å‹•ä½œä¸­ï¼‰
                        if (error.message && error.message.includes('network')) {
                            console.log('âš ï¸ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ¶é™ï¼ˆåºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ï¼‰ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸãŒã€åŒæœŸã¯ç¶™ç¶šä¸­ã§ã™');
                            return;
                        }
                        console.error('âŒ Firestore ãƒªã‚¹ãƒŠãƒ¼ ã‚¨ãƒ©ãƒ¼:', error);
                        this.updateFirebaseStatus('error');
                    });
                    
                    // åˆå›ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    this.uploadToFirebase();
                    
                    console.log('âœ… Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹');
                    this.updateFirebaseStatus('success');
                    
                    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å®šæœŸçš„ã«å‡ºåŠ›
                    this.startSyncMonitoring();
                    
                } catch (error) {
                    console.error('âŒ FirebaseåŒæœŸé–‹å§‹ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateFirebaseStatus('error');
                }
            }
            
            async uploadToFirebase() {
                if (!this.firestore || !this.user || this.syncInProgress) return;
                
                this.syncInProgress = true;
                
                try {
                    const { doc, setDoc } = window.FirebaseSDK;
                    
                    const userData = {
                        tasks: this.tasks,
                        clients: this.clients,
                        subtasks: this.subtasks,
                        timeLogs: this.timeLogs,
                        settings: this.settings,
                        lastModified: Date.now(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            timestamp: new Date().toISOString()
                        }
                    };
                    
                    const userDocRef = doc(this.firestore, 'users', this.user.uid);
                    await setDoc(userDocRef, userData);
                    
                    this.lastSyncTime = userData.lastModified;
                    console.log('ğŸ“¤ Firebaseã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†:', {
                        userId: this.user.uid,
                        dataSize: JSON.stringify(userData).length,
                        tasksCount: userData.tasks.length,
                        timestamp: new Date(userData.lastModified).toLocaleString()
                    });
                    
                } catch (error) {
                    console.error('âŒ Firebaseã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    this.syncInProgress = false;
                }
            }
            
            mergeFirebaseData(firebaseData) {
                console.log('ğŸ“¥ Firebaseãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒ¼ã‚¸ä¸­...', {
                    firebaseTimestamp: new Date(firebaseData.lastModified).toLocaleString(),
                    localTimestamp: this.lastSyncTime ? new Date(this.lastSyncTime).toLocaleString() : 'ãªã—',
                    tasksCount: firebaseData.tasks?.length || 0,
                    clientsCount: firebaseData.clients?.length || 0
                });
                
                // ä¸€æ™‚çš„ã«åŒæœŸãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                this.syncInProgress = true;
                
                try {
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨å‰ã®çŠ¶æ…‹ã‚’è¨˜éŒ²
                    const beforeCount = {
                        tasks: this.tasks?.length || 0,
                        clients: this.clients?.length || 0,
                        subtasks: this.subtasks?.length || 0,
                        timeLogs: this.timeLogs?.length || 0
                    };
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
                    if (firebaseData.tasks) {
                        this.tasks = firebaseData.tasks;
                        console.log('âœ… ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', `${beforeCount.tasks} â†’ ${this.tasks.length}ä»¶`);
                    } else {
                        console.log('âš ï¸ Firebaseã«ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                    
                    if (firebaseData.clients) {
                        this.clients = firebaseData.clients;
                        console.log('âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', `${beforeCount.clients} â†’ ${this.clients.length}ä»¶`);
                    } else {
                        console.log('âš ï¸ Firebaseã«é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                    
                    if (firebaseData.subtasks) {
                        this.subtasks = firebaseData.subtasks;
                        console.log('âœ… ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', `${beforeCount.subtasks} â†’ ${this.subtasks.length}ä»¶`);
                    } else {
                        console.log('âš ï¸ Firebaseã«ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                    
                    if (firebaseData.timeLogs) {
                        this.timeLogs = firebaseData.timeLogs;
                        console.log('âœ… æ™‚é–“ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', `${beforeCount.timeLogs} â†’ ${this.timeLogs.length}ä»¶`);
                    } else {
                        console.log('âš ï¸ Firebaseã«æ™‚é–“ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                    
                    if (firebaseData.settings) {
                        this.settings = { ...this.settings, ...firebaseData.settings };
                        console.log('âœ… è¨­å®šãƒ‡ãƒ¼ã‚¿æ›´æ–°');
                    }
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜
                    this.saveData();
                    
                    // UIæ›´æ–°ï¼ˆå¼·åˆ¶å®Ÿè¡Œï¼‰
                    console.log('ğŸ”„ UIæ›´æ–°é–‹å§‹...');
                    
                    // ã‚¿ã‚¹ã‚¯è¡¨ç¤ºã‚’å¼·åˆ¶æ›´æ–°
                    if (typeof this.renderTasks === 'function') {
                        this.renderTasks();
                        console.log('âœ… ã‚¿ã‚¹ã‚¯ç”»é¢æ›´æ–°å®Œäº†');
                    } else {
                        console.error('âŒ renderTasksé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // é¡§å®¢è¡¨ç¤ºã‚’å¼·åˆ¶æ›´æ–°  
                    if (typeof this.renderClients === 'function') {
                        this.renderClients();
                        console.log('âœ… é¡§å®¢ç”»é¢æ›´æ–°å®Œäº†');
                    } else {
                        console.error('âŒ renderClientsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // è¨­å®šã‚’å¼·åˆ¶æ›´æ–°
                    if (typeof this.loadSettings === 'function') {
                        this.loadSettings();
                        console.log('âœ… è¨­å®šæ›´æ–°å®Œäº†');
                    } else {
                        console.error('âŒ loadSettingsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                    // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¿ãƒ–ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.trim();
                        console.log('ğŸ”„ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–å†æç”»:', tabName);
                        activeTab.click();
                    }
                    
                    // åŒæœŸæ™‚åˆ»ã‚’æ›´æ–°
                    this.lastSyncTime = firebaseData.lastModified;
                    
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸å®Œäº† - UIæ›´æ–°æ¸ˆã¿');
                    
                    // æˆåŠŸã‚’è¦–è¦šçš„ã«è¡¨ç¤º
                    this.showSyncSuccess();
                    
                } catch (error) {
                    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ã‚¨ãƒ©ãƒ¼:', error);
                } finally {
                    // å¿…ãšåŒæœŸãƒ•ãƒ©ã‚°ã‚’è§£é™¤
                    this.syncInProgress = false;
                }
            }
            
            updateFirebaseStatus(status) {
                const indicator = document.getElementById('firebase-status');
                if (indicator) {
                    indicator.className = `sync-status ${status} ml-2`;
                    indicator.textContent = status === 'success' ? 'ğŸŸ¢' : status === 'error' ? 'ğŸ”´' : 'ğŸŸ¡';
                }
                
                // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                const modeText = document.getElementById('sync-mode-text');
                if (modeText) {
                    if (status === 'success') {
                        modeText.textContent = 'ğŸ”¥ Firebase ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰';
                    } else if (status === 'error') {
                        modeText.textContent = 'âŒ Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰';
                    } else {
                        modeText.textContent = 'ğŸŸ¡ Firebaseæ¥ç¶šä¸­...';
                    }
                }
                
                this.updateLastSyncDisplay();
            }
            
            showSyncSuccess() {
                // åŒæœŸæˆåŠŸã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                const indicator = document.getElementById('firebase-status');
                if (indicator) {
                    // ä¸€æ™‚çš„ã«ç·‘è‰²ã®ç‚¹æ»…åŠ¹æœ
                    indicator.style.animation = 'pulse 0.5s ease-in-out 2';
                    indicator.textContent = 'ğŸ’š';
                    
                    setTimeout(() => {
                        indicator.textContent = 'ğŸŸ¢';
                        indicator.style.animation = '';
                    }, 1000);
                }
                
                console.log('ğŸ‰ åŒæœŸå®Œäº† - ãƒ‡ãƒ¼ã‚¿ãŒä»–ã®ç«¯æœ«ã¨åŒæœŸã•ã‚Œã¾ã—ãŸ');
            }
            
            showGoogleAuthPrompt() {
                // Googleèªè¨¼ãŒå¿…è¦ãªå ´åˆã®UIæ›´æ–°
                const authStatus = document.getElementById('google-auth-status');
                const signinBtn = document.getElementById('google-signin-btn');
                const signoutBtn = document.getElementById('google-signout-btn');
                const userInfo = document.getElementById('google-user-info');
                
                if (authStatus) authStatus.textContent = 'ğŸ”´';
                if (signinBtn) signinBtn.style.display = 'block';
                if (signoutBtn) signoutBtn.style.display = 'none';
                if (userInfo) userInfo.classList.add('hidden');
            }
            
            updateGoogleAuthUI(user) {
                // Googleèªè¨¼æˆåŠŸæ™‚ã®UIæ›´æ–°
                const authStatus = document.getElementById('google-auth-status');
                const signinBtn = document.getElementById('google-signin-btn');
                const signoutBtn = document.getElementById('google-signout-btn');
                const userInfo = document.getElementById('google-user-info');
                const userName = document.getElementById('user-name');
                const userEmail = document.getElementById('user-email');
                const userPhoto = document.getElementById('user-photo');
                
                if (authStatus) authStatus.textContent = 'ğŸŸ¢';
                if (signinBtn) signinBtn.style.display = 'none';
                if (signoutBtn) signoutBtn.style.display = 'block';
                if (userInfo) userInfo.classList.remove('hidden');
                if (userName) userName.textContent = user.displayName || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼';
                if (userEmail) userEmail.textContent = user.email || '';
                if (userPhoto) userPhoto.src = user.photoURL || '';
                
                // FirebaseåŒæœŸãƒˆã‚°ãƒ«ã‚’æœ‰åŠ¹åŒ–
                const syncToggle = document.getElementById('firebase-sync-toggle');
                if (syncToggle) {
                    syncToggle.disabled = false;
                    syncToggle.checked = true;
                }
            }
            
            async signInWithGoogle() {
                try {
                    // ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
                    const isArcBrowser = navigator.userAgent.includes('Arc') || 
                                       window.navigator.userAgent.includes('Arc') ||
                                       /Arc\//.test(navigator.userAgent);
                    
                    if (isArcBrowser) {
                        console.log('ğŸŒ Arcãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¤œå‡º');
                        
                        // Arcç”¨ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        const useArc = confirm(
                            'ğŸŒ Arcãƒ–ãƒ©ã‚¦ã‚¶ã‚’æ¤œå‡ºã—ã¾ã—ãŸ\n\n' +
                            'Arcãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯èªè¨¼ãŒä¸å®‰å®šãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚\n\n' +
                            'âœ… ç¶šè¡Œã™ã‚‹ï¼ˆArcã§è©¦è¡Œï¼‰\n' +
                            'âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆChromeæ¨å¥¨ï¼‰\n\n' +
                            'Arcã§å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€Chrome/Safari/Edgeã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'
                        );
                        
                        if (!useArc) {
                            alert('Chromeã€Safariã€Edgeãªã©ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã”åˆ©ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚');
                            return;
                        }
                    }
                    
                    // Firebase SDK ã®å®‰å…¨ãªèª­ã¿è¾¼ã¿ç¢ºèª
                    if (!window.FirebaseSDK) {
                        alert('âŒ Firebase SDK ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
                        return;
                    }
                    
                    const { GoogleAuthProvider, signInWithRedirect, getRedirectResult } = window.FirebaseSDK;
                    const provider = new GoogleAuthProvider();
                    
                    // Arcãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ã‚ˆã‚Šå®‰å…¨ãªã‚¹ã‚³ãƒ¼ãƒ—è¨­å®š
                    if (isArcBrowser) {
                        provider.addScope('profile');
                        provider.addScope('email');
                        provider.setCustomParameters({
                            prompt: 'select_account'
                        });
                    }
                    
                    // æ—¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆçµæœãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const result = await getRedirectResult(this.auth);
                    
                    if (result) {
                        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆ
                        const user = result.user;
                        console.log('âœ… Googleèªè¨¼æˆåŠŸï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰:', user.email);
                        this.updateGoogleAuthUI(user);
                        return;
                    }
                    
                    // Arcãƒ–ãƒ©ã‚¦ã‚¶ã®å ´åˆã¯ç›´æ¥ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ä½¿ç”¨
                    if (isArcBrowser) {
                        console.log('ğŸ”„ Arcãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆèªè¨¼é–‹å§‹');
                        await signInWithRedirect(this.auth, provider);
                        return;
                    }
                    
                    // ä»–ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è©¦è¡Œ
                    try {
                        const { signInWithPopup } = window.FirebaseSDK;
                        const popupResult = await signInWithPopup(this.auth, provider);
                        const user = popupResult.user;
                        console.log('âœ… Googleèªè¨¼æˆåŠŸï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰:', user.email);
                        this.updateGoogleAuthUI(user);
                        
                    } catch (popupError) {
                        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤±æ•—æ™‚ã¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ä½¿ç”¨
                        console.log('â„¹ï¸ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤±æ•—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ');
                        await signInWithRedirect(this.auth, provider);
                    }
                    
                } catch (error) {
                    console.error('âŒ Googleèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                    
                    if (error.code === 'auth/unauthorized-domain') {
                        alert(`âŒ ãƒ‰ãƒ¡ã‚¤ãƒ³æ‰¿èªã‚¨ãƒ©ãƒ¼\n\nFirebase Console ã§ä»¥ä¸‹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ‰¿èªã—ã¦ãã ã•ã„ï¼š\nâ€¢ ${window.location.hostname}\nâ€¢ ${window.location.origin}`);
                    } else if (error.code === 'auth/popup-blocked') {
                        alert('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨­å®šã‚’ç¢ºèªã™ã‚‹ã‹ã€Chrome/Safariã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                    } else {
                        alert('âŒ Googleèªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message + '\n\nArcãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠä½¿ã„ã®å ´åˆã¯ã€Chrome/Safari/Edgeã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                }
            }
            
            async signOutGoogle() {
                try {
                    const { signOut } = window.FirebaseSDK;
                    await signOut(this.auth);
                    
                    console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
                    this.showGoogleAuthPrompt();
                    
                } catch (error) {
                    console.error('âŒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            showAdBlockerNotice() {
                // åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼æ¤œçŸ¥æ™‚ã®é€šçŸ¥
                const notice = document.createElement('div');
                notice.className = 'fixed top-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-lg z-50 max-w-sm';
                notice.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-alt text-yellow-500"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700">
                                <strong>åºƒå‘Šãƒ–ãƒ­ãƒƒã‚«ãƒ¼ã‚’æ¤œçŸ¥</strong><br>
                                åŒæœŸã¯æ­£å¸¸å‹•ä½œä¸­ã§ã™ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ç„¡è¦–ã—ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
                            </p>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="mt-2 text-xs bg-yellow-200 px-2 py-1 rounded">
                                ç†è§£ã—ã¾ã—ãŸ
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(notice);
                
                // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
                setTimeout(() => {
                    if (notice.parentElement) {
                        notice.remove();
                    }
                }, 10000);
            }
            
            startSyncMonitoring() {
                // 30ç§’ã”ã¨ã«åŒæœŸçŠ¶æ…‹ã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                if (this.syncMonitorInterval) {
                    clearInterval(this.syncMonitorInterval);
                }
                
                this.syncMonitorInterval = setInterval(() => {
                    if (this.firestore && this.user) {
                        console.log('ğŸ“Š åŒæœŸãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°:', {
                            userId: this.user.uid.substring(0, 8) + '...',
                            lastSyncTime: this.lastSyncTime ? new Date(this.lastSyncTime).toLocaleString() : 'ãªã—',
                            syncInProgress: this.syncInProgress,
                            tasksCount: this.tasks.length,
                            clientsCount: this.clients.length,
                            listenerActive: !!this.unsubscribeFirestore
                        });
                    }
                }, 30000); // 30ç§’é–“éš”
            }
            
            async testFirebaseConnection() {
                const apiKey = document.getElementById('firebase-api-key').value;
                const projectId = document.getElementById('firebase-project-id').value;
                
                if (!apiKey || !projectId) {
                    alert('API Keyã¨Project IDã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                try {
                    this.updateFirebaseStatus('syncing');
                    
                    const config = {
                        apiKey: apiKey,
                        authDomain: `${projectId}.firebaseapp.com`,
                        projectId: projectId,
                        storageBucket: `${projectId}.appspot.com`,
                        messagingSenderId: "123456789",
                        appId: "1:123456789:web:abcdef"
                    };
                    
                    // ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–
                    const { initializeApp, getFirestore, getAuth, signInAnonymously } = window.FirebaseSDK;
                    const testApp = initializeApp(config, 'test-app');
                    const testAuth = getAuth(testApp);
                    
                    await signInAnonymously(testAuth);
                    
                    this.firebaseConfig = config;
                    this.updateFirebaseStatus('success');
                    alert('âœ… Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
                    
                } catch (error) {
                    console.error('âŒ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    this.updateFirebaseStatus('error');
                    alert('âŒ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            }
            
            // ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸæ©Ÿèƒ½ï¼ˆæ—§APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ - éæ¨å¥¨ï¼‰
            async syncWithAPI() {
                if (this.syncInProgress || !this.syncEnabled) return;
                
                this.syncInProgress = true;
                console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿åŒæœŸé–‹å§‹...');
                
                try {
                    // ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šAPIæ¥ç¶šç¢ºèª
                    const testResponse = await fetch('tables/tasks?limit=1');
                    
                    if (testResponse.ok) {
                        // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é †ç•ªã«åŒæœŸ
                        await Promise.all([
                            this.syncTable('tasks', this.tasks),
                            this.syncTable('clients', this.clients),
                            this.syncTable('subtasks', this.subtasks),
                            this.syncTable('time_logs', this.timeLogs)
                        ]);
                        
                        this.lastSyncTime = Date.now();
                        this.updateSyncStatus('success', true); // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ¢ãƒ¼ãƒ‰
                        console.log('âœ… ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸå®Œäº†');
                    } else {
                        throw new Error(`API Error: ${testResponse.status}`);
                    }
                    
                } catch (error) {
                    console.error('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    // APIæ¥ç¶šå¤±æ•—æ™‚ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ã§å‹•ä½œ
                    this.lastSyncTime = Date.now();
                    this.updateSyncStatus('success', false); // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰
                    console.log('ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œä¸­');
                } finally {
                    this.syncInProgress = false;
                }
            }
            
            async syncTable(tableName, localData) {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const response = await fetch(`tables/${tableName}`);
                const serverData = await response.json();
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã¨ã‚µãƒ¼ãƒãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ¯”è¼ƒãƒ»ãƒãƒ¼ã‚¸
                const mergedData = this.mergeData(localData, serverData.data || []);
                
                // å·®åˆ†ãŒã‚ã‚Œã°æ›´æ–°
                if (JSON.stringify(localData) !== JSON.stringify(mergedData)) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚’æ›´æ–°
                    this.updateLocalData(tableName, mergedData);
                    
                    // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                    for (const item of mergedData) {
                        if (item._needsSync) {
                            await this.syncItemToServer(tableName, item);
                            delete item._needsSync;
                        }
                    }
                }
                
                return mergedData;
            }
            
            mergeData(localData, serverData) {
                const merged = new Map();
                
                // ã‚µãƒ¼ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«è¿½åŠ 
                serverData.forEach(item => {
                    merged.set(item.id, { ...item, _source: 'server' });
                });
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãï¼ˆæ–°ã—ã„ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—å„ªå…ˆï¼‰
                localData.forEach(item => {
                    const existing = merged.get(item.id);
                    if (!existing || (item.updated_at || item.created_at) > (existing.updated_at || existing.created_at)) {
                        merged.set(item.id, { ...item, _source: 'local', _needsSync: true });
                    }
                });
                
                return Array.from(merged.values());
            }
            
            updateLocalData(tableName, data) {
                switch(tableName) {
                    case 'tasks':
                        this.tasks = data;
                        localStorage.setItem('taskflow_tasks', JSON.stringify(this.tasks));
                        break;
                    case 'clients':
                        this.clients = data;
                        localStorage.setItem('taskflow_clients', JSON.stringify(this.clients));
                        break;
                    case 'subtasks':
                        this.subtasks = data;
                        localStorage.setItem('taskflow_subtasks', JSON.stringify(this.subtasks));
                        break;
                    case 'time_logs':
                        this.timeLogs = data;
                        localStorage.setItem('taskflow_time_logs', JSON.stringify(this.timeLogs));
                        break;
                }
            }
            
            async syncItemToServer(tableName, item) {
                try {
                    const cleanItem = { ...item };
                    delete cleanItem._source;
                    delete cleanItem._needsSync;
                    
                    if (cleanItem.id) {
                        // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã®æ›´æ–°
                        await fetch(`tables/${tableName}/${cleanItem.id}`, {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(cleanItem)
                        });
                    } else {
                        // æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆ
                        const response = await fetch(`tables/${tableName}`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(cleanItem)
                        });
                        const created = await response.json();
                        // IDã‚’æ›´æ–°
                        item.id = created.id;
                    }
                } catch (error) {
                    console.error(`âŒ ${tableName}åŒæœŸã‚¨ãƒ©ãƒ¼:`, error);
                }
            }
            
            updateSyncStatus(status, isCloudMode = true) {
                const indicator = document.getElementById('sync-indicator');
                if (indicator) {
                    indicator.className = `sync-status ${status} ml-2`;
                    indicator.textContent = status === 'success' ? 'ğŸŸ¢' : status === 'error' ? 'ğŸ”´' : 'ğŸŸ¡';
                    console.log('ğŸ”„ åŒæœŸçŠ¶æ…‹æ›´æ–°:', status, indicator.textContent);
                }
                
                // ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
                const modeText = document.getElementById('sync-mode-text');
                if (modeText) {
                    if (status === 'success') {
                        modeText.textContent = isCloudMode ? 
                            'ğŸŒ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒã‚¤ã‚¹é–“åŒæœŸæœ‰åŠ¹ï¼‰' : 
                            'ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ï¼ˆå˜ä¸€ãƒ‡ãƒã‚¤ã‚¹å°‚ç”¨ï¼‰';
                    } else {
                        modeText.textContent = 'âš ï¸ åŒæœŸè¨­å®šç¢ºèªä¸­...';
                    }
                }
                
                // æœ€çµ‚åŒæœŸæ™‚åˆ»ã‚’æ›´æ–°
                this.updateLastSyncDisplay();
                
                // è¨­å®šã‚’ä¿å­˜
                this.settings.lastSyncTime = this.lastSyncTime;
                this.settings.syncEnabled = this.syncEnabled;
                localStorage.setItem('taskflow_settings', JSON.stringify(this.settings));
            }
            
            updateLastSyncDisplay() {
                const element = document.getElementById('last-sync-time');
                if (element) {
                    if (this.lastSyncTime) {
                        const date = new Date(this.lastSyncTime);
                        element.textContent = date.toLocaleString('ja-JP');
                    } else {
                        element.textContent = 'æœªåŒæœŸ';
                    }
                }
            }
            
            startAutoSync() {
                if (this.syncInterval) clearInterval(this.syncInterval);
                
                console.log('ğŸš€ è‡ªå‹•åŒæœŸé–‹å§‹');
                // 30ç§’ã”ã¨ã«è‡ªå‹•åŒæœŸ
                this.syncInterval = setInterval(() => {
                    this.syncWithAPI();
                }, 30000);
                
                // åˆå›åŒæœŸ
                this.syncWithAPI();
            }
            
            saveFirebaseSettings() {
                const apiKey = document.getElementById('firebase-api-key').value;
                const projectId = document.getElementById('firebase-project-id').value;
                
                if (!apiKey || !projectId) {
                    alert('API Keyã¨Project IDã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                this.firebaseConfig = {
                    apiKey: apiKey,
                    authDomain: `${projectId}.firebaseapp.com`,
                    projectId: projectId,
                    storageBucket: `${projectId}.appspot.com`,
                    messagingSenderId: "123456789",
                    appId: "1:123456789:web:abcdef"
                };
                
                this.firebaseEnabled = true;
                this.saveSettings();
                
                // FirebaseåˆæœŸåŒ–
                this.initializeFirebase();
                
                alert('âœ… Firebaseè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚åŒæœŸã‚’é–‹å§‹ã—ã¾ã™ã€‚');
            }
            
            stopFirebaseSync() {
                if (this.unsubscribeFirestore) {
                    this.unsubscribeFirestore();
                    this.unsubscribeFirestore = null;
                }
                
                this.firebaseApp = null;
                this.firestore = null;
                this.auth = null;
                this.user = null;
                this.firebaseEnabled = false;
                
                this.updateFirebaseStatus('error');
                console.log('ğŸ”¥ FirebaseåŒæœŸã‚’åœæ­¢ã—ã¾ã—ãŸ');
            }
            
            stopAutoSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }
            }
            
            bindEvents() {
                // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // e.currentTargetã‚’ä½¿ç”¨ã—ã¦ãƒœã‚¿ãƒ³è¦ç´ è‡ªä½“ã‚’å–å¾—
                        const tab = e.currentTarget.dataset.tab;
                        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆãƒ­ã‚°ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                        // console.log('ğŸ¯ ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:', tab);
                        if (tab) {
                            this.switchTab(tab);
                        }
                    });
                });
                
                // ã‚¿ã‚¹ã‚¯é–¢é€£
                document.getElementById('add-task-btn').addEventListener('click', () => this.openTaskModal());
                document.getElementById('close-modal').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('cancel-btn').addEventListener('click', () => this.closeTaskModal());
                document.getElementById('task-form').addEventListener('submit', (e) => this.handleTaskSubmit(e));
                document.getElementById('add-subtask-btn').addEventListener('click', () => this.addSubtaskInput());
                
                // é¡§å®¢é–¢é€£
                document.getElementById('add-client-btn').addEventListener('click', () => this.openClientModal());
                document.getElementById('close-client-modal').addEventListener('click', () => this.closeClientModal());
                document.getElementById('cancel-client-btn').addEventListener('click', () => this.closeClientModal());
                document.getElementById('client-form').addEventListener('submit', (e) => this.handleClientSubmit(e));
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ»æ¤œç´¢
                document.getElementById('search-input').addEventListener('input', () => this.renderTasks());
                document.getElementById('filter-status').addEventListener('change', () => this.renderTasks());
                document.getElementById('filter-priority').addEventListener('change', () => this.renderTasks());
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                document.getElementById('gantt-prev-month').addEventListener('click', () => this.changeGanttMonth(-1));
                document.getElementById('gantt-next-month').addEventListener('click', () => this.changeGanttMonth(1));
                document.getElementById('gantt-today-month').addEventListener('click', () => this.goToCurrentMonth());
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆåˆæœŸåŒ–æ™‚ã«è¨­å®šï¼‰
                this.bindGanttEvents();
                
                // è¨­å®š
                // ğŸ”¥ Firebaseè¨­å®š
                const firebaseSyncToggle = document.getElementById('firebase-sync-toggle');
                if (firebaseSyncToggle) {
                    firebaseSyncToggle.addEventListener('change', (e) => {
                        const configPanel = document.getElementById('firebase-config');
                        if (e.target.checked) {
                            configPanel.classList.remove('hidden');
                        } else {
                            configPanel.classList.add('hidden');
                            this.firebaseEnabled = false;
                            this.stopFirebaseSync();
                        }
                    });
                }
                
                const firebaseTestBtn = document.getElementById('firebase-test-btn');
                if (firebaseTestBtn) {
                    firebaseTestBtn.addEventListener('click', () => this.testFirebaseConnection());
                }
                
                const firebaseSaveBtn = document.getElementById('firebase-save-btn');
                if (firebaseSaveBtn) {
                    firebaseSaveBtn.addEventListener('click', () => this.saveFirebaseSettings());
                }
                
                const firebaseManualSyncBtn = document.getElementById('firebase-manual-sync-btn');
                if (firebaseManualSyncBtn) {
                    firebaseManualSyncBtn.addEventListener('click', async () => {
                        console.log('ğŸ”„ æ‰‹å‹•åŒæœŸå®Ÿè¡Œ...');
                        firebaseManualSyncBtn.disabled = true;
                        firebaseManualSyncBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>åŒæœŸä¸­...';
                        
                        try {
                            if (this.firestore && this.user) {
                                const { doc, getDoc } = window.FirebaseSDK;
                                const userDocRef = doc(this.firestore, 'users', this.user.uid);
                                const docSnap = await getDoc(userDocRef);
                                
                                if (docSnap.exists()) {
                                    const firebaseData = docSnap.data();
                                    this.lastSyncTime = 0; // å¼·åˆ¶æ›´æ–°
                                    this.mergeFirebaseData(firebaseData);
                                    alert(`âœ… åŒæœŸå®Œäº†ï¼\nã‚¿ã‚¹ã‚¯: ${firebaseData.tasks?.length || 0}ä»¶\né¡§å®¢: ${firebaseData.clients?.length || 0}ä»¶`);
                                } else {
                                    await this.uploadToFirebase();
                                    alert('âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚');
                                }
                            } else {
                                alert('âŒ Firebaseæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                            }
                        } catch (error) {
                            console.error('âŒ æ‰‹å‹•åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                            alert('âŒ åŒæœŸã‚¨ãƒ©ãƒ¼: ' + error.message);
                        } finally {
                            firebaseManualSyncBtn.disabled = false;
                            firebaseManualSyncBtn.innerHTML = '<i class="fas fa-sync mr-1"></i>æ‰‹å‹•åŒæœŸå®Ÿè¡Œ';
                        }
                    });
                }
                
                // ğŸ” æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»å–å¾—æ©Ÿèƒ½ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
                setTimeout(() => {
                    const firebaseSearchBtn = document.getElementById('firebase-search-existing-btn');
                    if (firebaseSearchBtn) {
                        firebaseSearchBtn.addEventListener('click', async () => {
                    console.log('ğŸ” æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢é–‹å§‹...');
                    existingDataBtn.disabled = true;
                    existingDataBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>æ¤œç´¢ä¸­...';
                    
                    try {
                        if (!this.firestore) {
                            alert('âŒ Firebaseæœªæ¥ç¶š');
                            return;
                        }
                        
                        const { collection, getDocs } = window.FirebaseSDK;
                        const usersRef = collection(this.firestore, 'users');
                        const snapshot = await getDocs(usersRef);
                        
                        console.log('ğŸ“Š Firebaseãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§:');
                        const availableUsers = [];
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const userInfo = {
                                userId: doc.id,
                                tasksCount: data.tasks?.length || 0,
                                clientsCount: data.clients?.length || 0,
                                lastModified: data.lastModified ? new Date(data.lastModified).toLocaleString() : 'ãªã—'
                            };
                            console.log(`ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${doc.id}`, userInfo);
                            availableUsers.push({ id: doc.id, data, info: userInfo });
                        });
                        
                        if (availableUsers.length === 0) {
                            alert('ğŸ“„ Firebaseã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                            return;
                        }
                        
                        // æœ€ã‚‚ãƒ‡ãƒ¼ã‚¿ãŒå¤šã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ
                        const bestUser = availableUsers.reduce((prev, current) => {
                            const prevTotal = (prev.data.tasks?.length || 0) + (prev.data.clients?.length || 0);
                            const currentTotal = (current.data.tasks?.length || 0) + (current.data.clients?.length || 0);
                            return currentTotal > prevTotal ? current : prev;
                        });
                        
                        console.log('ğŸ¯ æœ€é©ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ:', bestUser.id, bestUser.info);
                        
                        const confirmMsg = `ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼š\n\n` +
                            `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${bestUser.id}\n` +
                            `ã‚¿ã‚¹ã‚¯: ${bestUser.info.tasksCount}ä»¶\n` +
                            `é¡§å®¢: ${bestUser.info.clientsCount}ä»¶\n` +
                            `æ›´æ–°æ—¥æ™‚: ${bestUser.info.lastModified}\n\n` +
                            `ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã™ã‹ï¼Ÿ`;
                        
                        if (confirm(confirmMsg)) {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å¤‰æ›´ã—ã¦å–å¾—
                            this.user = { uid: bestUser.id };
                            console.log('ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå¤‰æ›´:', bestUser.id);
                            
                            // ãƒ‡ãƒ¼ã‚¿ã‚’å¼·åˆ¶å–å¾—
                            this.lastSyncTime = 0; // å¼·åˆ¶æ›´æ–°
                            this.mergeFirebaseData(bestUser.data);
                            
                            alert('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼ç”»é¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        }
                        
                    } catch (error) {
                        console.error('âŒ ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
                        alert('âŒ ã‚¨ãƒ©ãƒ¼: ' + error.message);
                    } finally {
                        existingDataBtn.disabled = false;
                            firebaseSearchBtn.innerHTML = '<i class="fas fa-search mr-1"></i>æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»å–å¾—';
                        }
                    });
                    }
                }, 1000); // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
                
                // Googleèªè¨¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                setTimeout(() => {
                    const googleSigninBtn = document.getElementById('google-signin-btn');
                    const googleSignoutBtn = document.getElementById('google-signout-btn');
                    
                    if (googleSigninBtn) {
                        googleSigninBtn.addEventListener('click', () => this.signInWithGoogle());
                    }
                    if (googleSignoutBtn) {
                        googleSignoutBtn.addEventListener('click', () => this.signOutGoogle());
                    }
                }, 1000);
                
                document.getElementById('calendar-sync-toggle').addEventListener('change', (e) => {
                    document.getElementById('calendar-settings').classList.toggle('hidden', !e.target.checked);
                    this.saveSettings();
                });
                
                document.getElementById('desktop-notifications-toggle').addEventListener('change', () => this.saveSettings());
                document.getElementById('google-auth-btn').addEventListener('click', () => this.authenticateGoogleCalendar());
                document.getElementById('test-calendar-connection').addEventListener('click', () => this.testCalendarConnection());
                document.getElementById('sync-tasks-to-calendar').addEventListener('click', () => this.syncTasksToCalendar());
                
                // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
                document.getElementById('export-data-btn').addEventListener('click', () => this.exportData());
                document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-file-input').click());
                document.getElementById('import-file-input').addEventListener('change', (e) => this.importData(e));
                document.getElementById('clear-data-btn').addEventListener('click', () => this.clearAllData());
            }
            
            switchTab(tabName) {
                this.currentTab = tabName;
                
                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    }
                });
                
                // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤º
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tabName}-view`).classList.remove('hidden');
                
                // ã‚¿ãƒ–å›ºæœ‰ã®åˆæœŸåŒ–å‡¦ç†
                switch (tabName) {
                    case 'gantt':
                        this.renderGanttChart();
                        this.bindGanttEvents(); // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¿ãƒ–ã§ã‚¤ãƒ™ãƒ³ãƒˆå†è¨­å®š
                        break;
                    case 'clients':
                        this.renderClients();
                        break;
                    case 'reports':
                        this.renderReports();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }
            
            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            saveData() {
                // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼šå­˜åœ¨ã—ãªã„è¦ªã‚¿ã‚¹ã‚¯IDã‚’æŒã¤ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤
                const validTaskIds = this.tasks.map(t => t.id);
                this.subtasks = this.subtasks.filter(st => validTaskIds.includes(st.parent_task_id));
                
                localStorage.setItem('taskflow_tasks', JSON.stringify(this.tasks));
                localStorage.setItem('taskflow_clients', JSON.stringify(this.clients));
                localStorage.setItem('taskflow_subtasks', JSON.stringify(this.subtasks));
                localStorage.setItem('taskflow_time_logs', JSON.stringify(this.timeLogs));
                
                // ğŸ”¥ FirebaseåŒæœŸãƒˆãƒªã‚¬ãƒ¼
                if (this.firebaseEnabled && this.firestore && this.user && !this.syncInProgress) {
                    setTimeout(() => this.uploadToFirebase(), 500); // 0.5ç§’å¾Œã«åŒæœŸ
                }
            }
            
            saveSettings() {
                const settings = {
                    calendarSync: document.getElementById('calendar-sync-toggle').checked,
                    calendarId: document.getElementById('calendar-id').value,
                    googleApiKey: document.getElementById('google-api-key').value,
                    googleClientId: document.getElementById('google-client-id').value,
                    desktopNotifications: document.getElementById('desktop-notifications-toggle').checked,
                    // ğŸ”¥ Firebaseè¨­å®šã‚’è¿½åŠ 
                    firebaseEnabled: this.firebaseEnabled,
                    firebaseConfig: this.firebaseConfig,
                    lastSyncTime: this.lastSyncTime
                };
                this.settings = settings;
                localStorage.setItem('taskflow_settings', JSON.stringify(settings));
            }
            
            loadSettings() {
                // ğŸ”¥ Firebaseè¨­å®šã®èª­ã¿è¾¼ã¿
                const firebaseSyncToggle = document.getElementById('firebase-sync-toggle');
                if (firebaseSyncToggle) {
                    firebaseSyncToggle.checked = this.firebaseEnabled;
                    if (this.firebaseEnabled) {
                        document.getElementById('firebase-config').classList.remove('hidden');
                    }
                }
                
                if (this.firebaseConfig) {
                    const apiKeyField = document.getElementById('firebase-api-key');
                    const projectIdField = document.getElementById('firebase-project-id');
                    
                    if (apiKeyField && this.firebaseConfig.apiKey) {
                        apiKeyField.value = this.firebaseConfig.apiKey;
                    }
                    if (projectIdField && this.firebaseConfig.projectId) {
                        projectIdField.value = this.firebaseConfig.projectId;
                    }
                }
                
                this.updateLastSyncDisplay();
                
                if (this.settings.calendarSync) {
                    document.getElementById('calendar-sync-toggle').checked = true;
                    document.getElementById('calendar-settings').classList.remove('hidden');
                }
                if (this.settings.calendarId) {
                    document.getElementById('calendar-id').value = this.settings.calendarId;
                }
                if (this.settings.googleApiKey) {
                    document.getElementById('google-api-key').value = this.settings.googleApiKey;
                }
                if (this.settings.googleClientId) {
                    document.getElementById('google-client-id').value = this.settings.googleClientId;
                }
                if (this.settings.desktopNotifications) {
                    document.getElementById('desktop-notifications-toggle').checked = true;
                }
                
                // Google Calendar APIã®åˆæœŸåŒ–
                if (this.settings.googleApiKey && this.settings.googleClientId) {
                    this.initializeGoogleCalendarAPI();
                }
            }
            
            // ã‚¿ã‚¹ã‚¯ç®¡ç†æ©Ÿèƒ½
            openTaskModal(task = null) {
                this.currentEditingTask = task;
                const modal = document.getElementById('task-modal');
                const title = document.getElementById('modal-title');
                
                // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚³ãƒ³ãƒ†ãƒŠã‚’å¿…ãšã‚¯ãƒªã‚¢
                document.getElementById('subtasks-container').innerHTML = '';
                
                if (task) {
                    title.textContent = 'ã‚¿ã‚¹ã‚¯ã‚’ç·¨é›†';
                    this.populateTaskForm(task);
                } else {
                    title.textContent = 'æ–°ã—ã„ã‚¿ã‚¹ã‚¯';
                    document.getElementById('task-form').reset();
                }
                
                this.populateClientSelect();
                modal.classList.remove('hidden');
            }
            
            closeTaskModal() {
                document.getElementById('task-modal').classList.add('hidden');
                this.currentEditingTask = null;
            }
            
            populateTaskForm(task) {
                document.getElementById('task-id').value = task.id;
                document.getElementById('task-title').value = task.title || '';
                document.getElementById('task-deadline').value = task.deadline || '';
                document.getElementById('task-priority').value = task.priority || 'medium';
                
                if (task.scheduled_date) {
                    const localScheduled = new Date(task.scheduled_date);
                    localScheduled.setMinutes(localScheduled.getMinutes() - localScheduled.getTimezoneOffset());
                    document.getElementById('task-scheduled').value = localScheduled.toISOString().slice(0, 16);
                }
                
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-client').value = task.client_id || '';
                document.getElementById('task-estimated-hours').value = task.estimated_hours || '';
                
                // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’èª­ã¿è¾¼ã¿
                const taskSubtasks = this.subtasks.filter(st => st.parent_task_id === task.id);
                console.log(`ã‚¿ã‚¹ã‚¯ID ${task.id} ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯æ•°: ${taskSubtasks.length}`);
                taskSubtasks.forEach(subtask => {
                    console.log(`ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¿½åŠ : ${subtask.title} (parent: ${subtask.parent_task_id})`);
                    this.addSubtaskInput(subtask.title, subtask.completed, subtask.deadline);
                });
            }
            
            populateClientSelect() {
                const select = document.getElementById('task-client');
                select.innerHTML = '<option value="">é¡§å®¢ã‚’é¸æŠ</option>';
                
                this.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name}${client.company ? ` (${client.company})` : ''}`;
                    select.appendChild(option);
                });
            }
            
            addSubtaskInput(title = '', completed = false, deadline = '') {
                const container = document.getElementById('subtasks-container');
                const subtaskDiv = document.createElement('div');
                subtaskDiv.className = 'flex items-center gap-2 mb-2';
                
                subtaskDiv.innerHTML = `
                    <input type="checkbox" ${completed ? 'checked' : ''} class="custom-checkbox">
                    <input type="text" placeholder="ã‚µãƒ–ã‚¿ã‚¹ã‚¯" value="${title}" class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded">
                    <input type="date" value="${deadline}" class="px-2 py-1 text-sm border border-gray-300 rounded">
                    <button type="button" class="text-red-500 hover:text-red-700 remove-subtask">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                `;
                
                subtaskDiv.querySelector('.remove-subtask').addEventListener('click', () => {
                    subtaskDiv.remove();
                });
                
                container.appendChild(subtaskDiv);
            }
            
            handleTaskSubmit(e) {
                e.preventDefault();
                
                const taskData = {
                    id: this.currentEditingTask ? this.currentEditingTask.id : this.generateId(),
                    title: document.getElementById('task-title').value,
                    deadline: document.getElementById('task-deadline').value,
                    priority: document.getElementById('task-priority').value,
                    scheduled_date: document.getElementById('task-scheduled').value || null,
                    description: document.getElementById('task-description').value || '',
                    client_id: document.getElementById('task-client').value || null,
                    estimated_hours: parseFloat(document.getElementById('task-estimated-hours').value) || 0,
                    status: this.currentEditingTask ? this.currentEditingTask.status : 'pending',
                    actual_hours: this.currentEditingTask ? this.currentEditingTask.actual_hours : 0,
                    is_timing: this.currentEditingTask ? this.currentEditingTask.is_timing : false,
                    current_timer_start: this.currentEditingTask ? this.currentEditingTask.current_timer_start : null,
                    created_at: this.currentEditingTask ? this.currentEditingTask.created_at : new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // å…¥åŠ›æ¤œè¨¼
                if (!taskData.title.trim()) {
                    alert('ã‚¿ã‚¹ã‚¯åã¯å¿…é ˆã§ã™');
                    return;
                }
                
                if (!taskData.deadline) {
                    alert('æœŸé™ã¯å¿…é ˆã§ã™');
                    return;
                }
                
                // ã‚µãƒ–ã‚¿ã‚¹ã‚¯å‡¦ç†
                const subtaskElements = document.querySelectorAll('#subtasks-container > div');
                const taskSubtasks = [];
                
                subtaskElements.forEach(element => {
                    const titleInput = element.querySelector('input[type="text"]');
                    const completedInput = element.querySelector('input[type="checkbox"]');
                    const deadlineInput = element.querySelector('input[type="date"]');
                    
                    if (titleInput.value.trim()) {
                        taskSubtasks.push({
                            id: this.generateId(),
                            parent_task_id: taskData.id,
                            title: titleInput.value.trim(),
                            completed: completedInput.checked,
                            deadline: deadlineInput.value || null,
                            created_at: new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        });
                    }
                });
                
                // ã‚¿ã‚¹ã‚¯ã®ä¿å­˜ã¾ãŸã¯æ›´æ–°
                if (this.currentEditingTask) {
                    const index = this.tasks.findIndex(t => t.id === taskData.id);
                    this.tasks[index] = taskData;
                } else {
                    this.tasks.push(taskData);
                }
                
                // æ—¢å­˜ã®ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
                this.subtasks = this.subtasks.filter(st => st.parent_task_id !== taskData.id);
                if (taskSubtasks.length > 0) {
                    this.subtasks.push(...taskSubtasks);
                }
                
                this.saveData();
                this.closeTaskModal();
                this.renderTasks();
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
                if (this.currentTab === 'gantt') {
                    this.renderGanttChart();
                }
            }
            
            deleteTask(taskId) {
                if (confirm('ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.tasks = this.tasks.filter(t => t.id !== taskId);
                    this.subtasks = this.subtasks.filter(st => st.parent_task_id !== taskId);
                    this.timeLogs = this.timeLogs.filter(tl => tl.task_id !== taskId);
                    this.saveData();
                    this.renderTasks();
                    
                    if (this.currentTab === 'gantt') {
                        this.renderGanttChart();
                    }
                }
            }
            
            toggleTaskStatus(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    if (task.status === 'completed') {
                        task.status = 'pending';
                    } else {
                        task.status = 'completed';
                    }
                    task.updated_at = new Date().toISOString();
                    this.saveData();
                    this.renderTasks();
                    
                    if (this.currentTab === 'gantt') {
                        this.renderGanttChart();
                    }
                }
            }
            
            // æ™‚é–“è¿½è·¡æ©Ÿèƒ½
            toggleTimer(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) return;
                
                if (task.is_timing) {
                    // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                    const elapsedHours = (Date.now() - new Date(task.current_timer_start).getTime()) / (1000 * 60 * 60);
                    task.actual_hours = (task.actual_hours || 0) + elapsedHours;
                    task.is_timing = false;
                    task.current_timer_start = null;
                    
                    // æ™‚é–“ãƒ­ã‚°è¨˜éŒ²
                    this.timeLogs.push({
                        id: this.generateId(),
                        task_id: taskId,
                        start_time: task.current_timer_start,
                        end_time: new Date().toISOString(),
                        hours: elapsedHours,
                        created_at: new Date().toISOString()
                    });
                } else {
                    // ä»–ã®ã‚¿ã‚¹ã‚¯ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
                    this.tasks.forEach(t => {
                        if (t.is_timing) {
                            const elapsedHours = (Date.now() - new Date(t.current_timer_start).getTime()) / (1000 * 60 * 60);
                            t.actual_hours = (t.actual_hours || 0) + elapsedHours;
                            t.is_timing = false;
                            t.current_timer_start = null;
                        }
                    });
                    
                    // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
                    task.is_timing = true;
                    task.current_timer_start = new Date().toISOString();
                    if (task.status === 'pending') {
                        task.status = 'in_progress';
                    }
                }
                
                task.updated_at = new Date().toISOString();
                this.saveData();
                this.renderTasks();
            }
            
            startTimerUpdates() {
                setInterval(() => {
                    this.updateTimerDisplays();
                }, 1000);
            }
            
            updateTimerDisplays() {
                this.tasks.forEach(task => {
                    if (task.is_timing) {
                        const timerElement = document.querySelector(`[data-timer-task="${task.id}"]`);
                        if (timerElement) {
                            const elapsed = (Date.now() - new Date(task.current_timer_start).getTime()) / 1000;
                            const hours = Math.floor(elapsed / 3600);
                            const minutes = Math.floor((elapsed % 3600) / 60);
                            const seconds = Math.floor(elapsed % 60);
                            timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                        }
                    }
                });
            }
            
            renderTasks() {
                const container = document.getElementById('tasks-container');
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const statusFilter = document.getElementById('filter-status').value;
                const priorityFilter = document.getElementById('filter-priority').value;
                
                let filteredTasks = this.tasks.filter(task => {
                    const matchSearch = task.title.toLowerCase().includes(searchTerm) || 
                                      (task.description && task.description.toLowerCase().includes(searchTerm));
                    const matchStatus = !statusFilter || task.status === statusFilter;
                    const matchPriority = !priorityFilter || task.priority === priorityFilter;
                    
                    return matchSearch && matchStatus && matchPriority;
                });
                
                // æœŸé™ã¨å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆ
                filteredTasks.sort((a, b) => {
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    if (a.priority !== b.priority) {
                        return priorityOrder[b.priority] - priorityOrder[a.priority];
                    }
                    return new Date(a.deadline) - new Date(b.deadline);
                });
                
                container.innerHTML = '';
                
                if (filteredTasks.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-gray-500">
                            <i class="fas fa-tasks text-4xl mb-4"></i>
                            <p class="text-lg">ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>
                            <p class="text-sm">æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                        </div>
                    `;
                    return;
                }
                
                filteredTasks.forEach(task => {
                    const taskCard = this.createTaskCard(task);
                    container.appendChild(taskCard);
                });
            }
            
            createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow';
                
                const client = task.client_id ? this.clients.find(c => c.id === task.client_id) : null;
                const taskSubtasks = this.subtasks.filter(st => st.parent_task_id === task.id);
                const completedSubtasks = taskSubtasks.filter(st => st.completed);
                
                const statusClass = {
                    pending: 'bg-yellow-100 text-yellow-800',
                    in_progress: 'bg-blue-100 text-blue-800',
                    completed: 'bg-green-100 text-green-800'
                };
                
                const priorityClass = {
                    high: 'bg-red-100 text-red-800',
                    medium: 'bg-orange-100 text-orange-800',
                    low: 'bg-gray-100 text-gray-800'
                };
                
                const statusText = {
                    pending: 'æœªç€æ‰‹',
                    in_progress: 'é€²è¡Œä¸­',
                    completed: 'å®Œäº†'
                };
                
                const priorityText = {
                    high: 'é«˜',
                    medium: 'ä¸­',
                    low: 'ä½'
                };
                
                // æœŸé™ã¾ã§ã®æ—¥æ•°è¨ˆç®—
                const today = new Date();
                const deadline = new Date(task.deadline);
                const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                
                let deadlineClass = 'text-gray-600';
                let deadlineText = `${daysUntilDeadline}æ—¥å¾Œ`;
                
                if (daysUntilDeadline < 0) {
                    deadlineClass = 'text-red-600 font-semibold';
                    deadlineText = `${Math.abs(daysUntilDeadline)}æ—¥é…ã‚Œ`;
                } else if (daysUntilDeadline === 0) {
                    deadlineClass = 'text-red-600 font-semibold';
                    deadlineText = 'ä»Šæ—¥ãŒæœŸé™';
                } else if (daysUntilDeadline <= 3) {
                    deadlineClass = 'text-orange-600 font-semibold';
                }
                
                // ç¾åœ¨ã®ä½œæ¥­æ™‚é–“è¡¨ç¤º
                let currentTime = '';
                if (task.is_timing) {
                    currentTime = `<span data-timer-task="${task.id}" class="text-red-600 font-mono">è¨ˆæ¸¬ä¸­...</span>`;
                }
                
                card.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex items-start space-x-3 flex-1">
                            <button class="custom-checkbox mt-1 ${task.status === 'completed' ? 'checked' : ''}" 
                                    onclick="app.toggleTaskStatus('${task.id}')"></button>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 ${task.status === 'completed' ? 'line-through' : ''}">${task.title}</h3>
                                ${task.description ? `<p class="text-gray-600 text-sm mt-1">${task.description}</p>` : ''}
                                ${client ? `<p class="text-blue-600 text-sm mt-1"><i class="fas fa-user mr-1"></i>${client.name}${client.company ? ` (${client.company})` : ''}</p>` : ''}
                                
                                <div class="flex flex-wrap items-center gap-2 mt-3">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass[task.status]}">
                                        ${statusText[task.status]}
                                    </span>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${priorityClass[task.priority]}">
                                        ${priorityText[task.priority]}
                                    </span>
                                    <span class="text-xs ${deadlineClass}">
                                        <i class="fas fa-calendar mr-1"></i>${deadlineText}
                                    </span>
                                    ${task.estimated_hours > 0 ? `
                                        <span class="text-xs text-gray-600">
                                            <i class="fas fa-clock mr-1"></i>äºˆæƒ³: ${task.estimated_hours}h
                                        </span>
                                    ` : ''}
                                    ${task.actual_hours > 0 ? `
                                        <span class="text-xs text-gray-600">
                                            <i class="fas fa-hourglass-half mr-1"></i>å®Ÿç¸¾: ${task.actual_hours.toFixed(1)}h
                                        </span>
                                    ` : ''}
                                    ${currentTime}
                                </div>
                                
                                ${taskSubtasks.length > 0 ? `
                                    <div class="mt-3">
                                        <div class="text-xs text-gray-600 mb-2">
                                            ã‚µãƒ–ã‚¿ã‚¹ã‚¯: ${completedSubtasks.length}/${taskSubtasks.length} å®Œäº†
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${taskSubtasks.length > 0 ? (completedSubtasks.length / taskSubtasks.length) * 100 : 0}%"></div>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-2 ml-4">
                            <button class="timer-btn p-2 rounded-lg border border-gray-300 hover:bg-gray-50 ${task.is_timing ? 'running' : ''}"
                                    onclick="app.toggleTimer('${task.id}')" title="${task.is_timing ? 'ã‚¿ã‚¤ãƒãƒ¼åœæ­¢' : 'ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹'}">
                                <i class="fas ${task.is_timing ? 'fa-stop' : 'fa-play'} text-sm"></i>
                            </button>
                            <button class="p-2 rounded-lg border border-gray-300 hover:bg-gray-50"
                                    onclick="app.openTaskModal(app.tasks.find(t => t.id === '${task.id}'))" title="ç·¨é›†">
                                <i class="fas fa-edit text-sm text-gray-600"></i>
                            </button>
                            <button class="p-2 rounded-lg border border-gray-300 hover:bg-gray-50 text-red-600"
                                    onclick="app.deleteTask('${task.id}')" title="å‰Šé™¤">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                return card;
            }
            
            // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæ©Ÿèƒ½
            changeGanttMonth(direction) {
                this.ganttCurrentDate.setMonth(this.ganttCurrentDate.getMonth() + direction);
                this.renderGanttChart();
            }
            
            goToCurrentMonth() {
                this.ganttCurrentDate = new Date();
                this.renderGanttChart();
            }
            
            bindGanttEvents() {
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                try {
                    // å°‘ã—é…å»¶ã—ã¦DOMãŒå®Œå…¨ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
                    setTimeout(() => {
                        const searchInput = document.getElementById('gantt-search-input');
                        const clientFilter = document.getElementById('gantt-filter-client');
                        const statusFilter = document.getElementById('gantt-filter-status');
                        const subtaskToggle = document.getElementById('gantt-show-subtasks');
                        
                        console.log('ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå¯¾è±¡è¦ç´ :', {
                            searchInput: !!searchInput,
                            clientFilter: !!clientFilter, 
                            statusFilter: !!statusFilter,
                            subtaskToggle: !!subtaskToggle
                        });
                        
                        if (searchInput) {
                            // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
                            searchInput.removeEventListener('input', this.handleGanttSearch);
                            this.handleGanttSearch = () => {
                                console.log('ã‚¬ãƒ³ãƒˆæ¤œç´¢:', searchInput.value);
                                this.renderGanttChart();
                            };
                            searchInput.addEventListener('input', this.handleGanttSearch);
                        }
                        
                        if (clientFilter) {
                            // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒªã‚¢
                            clientFilter.removeEventListener('change', this.handleClientFilter);
                            this.handleClientFilter = (e) => {
                                console.log('ğŸ‘¥ é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´:', e.target.value);
                                console.log('âœ… ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ!', new Date().toISOString());
                                this.renderGanttChart();
                            };
                            clientFilter.addEventListener('change', this.handleClientFilter);
                            
                            // ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                            clientFilter.addEventListener('click', () => {
                                console.log('ğŸ“Œ é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                            });
                            
                            clientFilter.addEventListener('focus', () => {
                                console.log('ğŸ” é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹');
                            });
                            
                            clientFilter.addEventListener('blur', () => {
                                console.log('ğŸ”² é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã¾ã—ãŸ');
                            });
                            
                            // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶çš„ã«è¨­å®š
                            clientFilter.style.cssText += `
                                position: relative !important;
                                z-index: 100 !important;
                                pointer-events: auto !important;
                                background-color: white !important;
                                cursor: pointer !important;
                            `;
                            
                            console.log('ğŸ› ï¸ é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šå®Œäº†:', clientFilter.style.cssText);
                        }
                        
                        if (statusFilter) {
                            statusFilter.removeEventListener('change', this.handleStatusFilter);
                            this.handleStatusFilter = () => {
                                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¤‰æ›´:', statusFilter.value);
                                this.renderGanttChart();
                            };
                            statusFilter.addEventListener('change', this.handleStatusFilter);
                        }
                        
                        if (subtaskToggle) {
                            subtaskToggle.removeEventListener('change', this.handleSubtaskToggle);
                            this.handleSubtaskToggle = () => {
                                console.log('ã‚µãƒ–ã‚¿ã‚¹ã‚¯è¡¨ç¤ºå¤‰æ›´:', subtaskToggle.checked);
                                this.renderGanttChart();
                            };
                            subtaskToggle.addEventListener('change', this.handleSubtaskToggle);
                        }
                        
                        console.log('ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šå®Œäº†');
                    }, 100);
                    
                } catch (error) {
                    console.error('ã‚¬ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            populateGanttClientFilter() {
                const select = document.getElementById('gantt-filter-client');
                if (!select) {
                    console.warn('ã‚¬ãƒ³ãƒˆé¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const currentValue = select.value; // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
                select.innerHTML = '<option value="">å…¨é¡§å®¢</option>';
                
                console.log(`ğŸ‘¥ é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°: ${this.clients.length}ä»¶ã®é¡§å®¢ã‚’è¿½åŠ `);
                
                this.clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name}${client.company ? ` (${client.company})` : ''}`;
                    select.appendChild(option);
                });
                
                // å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
                if (currentValue && this.clients.some(c => c.id === currentValue)) {
                    select.value = currentValue;
                }
            }
            
            updateAllClientFilters() {
                // ã‚¿ã‚¹ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é¡§å®¢é¸æŠã‚’æ›´æ–°
                this.populateClientSelect();
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                this.populateGanttClientFilter();
                
                console.log('ğŸ”„ å…¨é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            }
            
            getFilteredGanttTasks() {
                const searchTerm = document.getElementById('gantt-search-input').value.toLowerCase();
                const clientFilter = document.getElementById('gantt-filter-client').value;
                const statusFilter = document.getElementById('gantt-filter-status').value;
                
                console.log('ã‚¬ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:', { searchTerm, clientFilter, statusFilter });
                
                const filtered = this.tasks.filter(task => {
                    const matchSearch = task.title.toLowerCase().includes(searchTerm) || 
                                      (task.description && task.description.toLowerCase().includes(searchTerm));
                    const matchClient = !clientFilter || task.client_id === clientFilter;
                    const matchStatus = !statusFilter || task.status === statusFilter;
                    
                    const matches = matchSearch && matchClient && matchStatus;
                    if (clientFilter && task.client_id === clientFilter) {
                        console.log(`ã‚¿ã‚¹ã‚¯ "${task.title}" ãŒé¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ãƒãƒƒãƒ: ${matches}`);
                    }
                    
                    return matches;
                });
                
                console.log(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ: ${this.tasks.length}å€‹ä¸­${filtered.length}å€‹ã‚’è¡¨ç¤º`);
                return filtered;
            }
            
            renderGanttChart() {
                const container = document.getElementById('gantt-container');
                const currentMonthText = document.getElementById('gantt-current-month');
                
                console.log(`ğŸ“ˆ ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆæç”»é–‹å§‹: ${this.clients.length}ä»¶ã®é¡§å®¢, ${this.tasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯`);
                
                // é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°
                this.populateGanttClientFilter();
                
                const year = this.ganttCurrentDate.getFullYear();
                const month = this.ganttCurrentDate.getMonth();
                
                currentMonthText.textContent = `${year}å¹´${month + 1}æœˆ`;
                
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’å–å¾—
                const filteredTasks = this.getFilteredGanttTasks();
                const showSubtasks = document.getElementById('gantt-show-subtasks').checked;
                
                // æœˆã®æ—¥æ•°ã‚’å–å¾—
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1);
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆHTMLç”Ÿæˆ
                let ganttHTML = `
                    <div class="gantt-wrapper">
                        <div class="gantt-fixed-column">
                            <div class="gantt-header px-4 py-2">
                                <div class="text-sm font-semibold text-gray-700">ã‚¿ã‚¹ã‚¯</div>
                            </div>
                `;
                
                // ã‚¿ã‚¹ã‚¯ã”ã¨ã®è¡Œã‚’ç”Ÿæˆ
                filteredTasks.forEach(task => {
                    const client = task.client_id ? this.clients.find(c => c.id === task.client_id) : null;
                    const taskSubtasks = showSubtasks ? this.subtasks.filter(st => st.parent_task_id === task.id) : [];
                    
                    ganttHTML += `
                        <div class="gantt-row gantt-task-row px-4 py-2 border-b border-gray-100" onclick="app.openTaskModal(app.tasks.find(t => t.id === '${task.id}'))">
                            <div class="text-sm font-medium text-gray-900 truncate">${task.title}</div>
                            <div class="text-xs text-gray-500 mt-1">
                                ${task.deadline} | ${task.priority === 'high' ? 'é«˜' : task.priority === 'medium' ? 'ä¸­' : 'ä½'}
                                ${client ? ` | ${client.name}` : ''}
                            </div>
                        </div>
                    `;
                    
                    // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã‚’è¡¨ç¤º
                    taskSubtasks.forEach(subtask => {
                        ganttHTML += `
                            <div class="gantt-row gantt-subtask px-4 py-1 border-b border-gray-50">
                                <div class="text-xs text-gray-600 truncate">â”” ${subtask.title}</div>
                                <div class="text-xs text-gray-400">
                                    ${subtask.deadline || 'æœŸé™ãªã—'} | ${subtask.completed ? 'å®Œäº†' : 'æœªå®Œäº†'}
                                </div>
                            </div>
                        `;
                    });
                });
                
                ganttHTML += `
                        </div>
                        <div class="gantt-scrollable-area">
                            <div class="gantt-content">
                                <div class="gantt-header flex">
                `;
                
                // æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                    const isToday = date.toDateString() === new Date().toDateString();
                    
                    ganttHTML += `
                        <div class="gantt-day-column ${isWeekend ? 'gantt-weekend' : ''} ${isToday ? 'gantt-today' : ''}">
                            <div class="text-xs font-medium">${day}</div>
                            <div class="text-xs text-gray-400">${['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][date.getDay()]}</div>
                        </div>
                    `;
                }
                
                ganttHTML += `
                                </div>
                `;
                
                // ã‚¿ã‚¹ã‚¯ãƒãƒ¼ç”Ÿæˆ
                filteredTasks.forEach(task => {
                    const taskStartDate = task.scheduled_date ? new Date(task.scheduled_date) : new Date(task.deadline);
                    const taskEndDate = new Date(task.deadline);
                    const taskSubtasks = showSubtasks ? this.subtasks.filter(st => st.parent_task_id === task.id) : [];
                    
                    // ãƒ¡ã‚¤ãƒ³ã‚¿ã‚¹ã‚¯ãƒãƒ¼
                    ganttHTML += `<div class="gantt-row flex">`;
                    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const currentDate = new Date(year, month, day);
                        
                        // ã‚¿ã‚¹ã‚¯ãŒã“ã®æ—¥ã«ã‹ã‹ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const isTaskDay = currentDate >= taskStartDate.setHours(0,0,0,0) && 
                                         currentDate <= taskEndDate.setHours(23,59,59,999);
                        
                        if (isTaskDay) {
                            const isStart = currentDate.toDateString() === taskStartDate.toDateString();
                            const priorityClass = task.priority === 'high' ? 'high-priority' : '';
                            const completedClass = task.status === 'completed' ? 'completed' : '';
                            
                            ganttHTML += `
                                <div class="gantt-day-column">
                                    <div class="gantt-task-bar ${priorityClass} ${completedClass}" 
                                         title="${task.title}" 
                                         onclick="app.openTaskModal(app.tasks.find(t => t.id === '${task.id}'))">
                                        ${isStart ? task.title.substring(0, 6) + (task.title.length > 6 ? '..' : '') : ''}
                                    </div>
                                </div>
                            `;
                        } else {
                            ganttHTML += `<div class="gantt-day-column"></div>`;
                        }
                    }
                    
                    ganttHTML += `</div>`;
                    
                    // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ãƒãƒ¼
                    taskSubtasks.forEach(subtask => {
                        ganttHTML += `<div class="gantt-row flex">`;
                        
                        for (let day = 1; day <= daysInMonth; day++) {
                            const currentDate = new Date(year, month, day);
                            
                            if (subtask.deadline) {
                                const subtaskDate = new Date(subtask.deadline);
                                const isSubtaskDay = currentDate.toDateString() === subtaskDate.toDateString();
                                
                                if (isSubtaskDay) {
                                    ganttHTML += `
                                        <div class="gantt-day-column">
                                            <div class="gantt-subtask-bar ${subtask.completed ? 'completed' : ''}" 
                                                 title="${subtask.title}">
                                                ${subtask.title.substring(0, 4) + (subtask.title.length > 4 ? '..' : '')}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    ganttHTML += `<div class="gantt-day-column"></div>`;
                                }
                            } else {
                                ganttHTML += `<div class="gantt-day-column"></div>`;
                            }
                        }
                        
                        ganttHTML += `</div>`;
                    });
                });
                
                ganttHTML += `
                            </div>
                        </div>
                    </div>
                `;
                
                container.innerHTML = ganttHTML;
            }
            
            // é¡§å®¢ç®¡ç†æ©Ÿèƒ½
            openClientModal(client = null) {
                this.currentEditingClient = client;
                const modal = document.getElementById('client-modal');
                const title = document.getElementById('client-modal-title');
                
                if (client) {
                    title.textContent = 'é¡§å®¢ã‚’ç·¨é›†';
                    this.populateClientForm(client);
                } else {
                    title.textContent = 'æ–°ã—ã„é¡§å®¢';
                    document.getElementById('client-form').reset();
                }
                
                modal.classList.remove('hidden');
            }
            
            closeClientModal() {
                document.getElementById('client-modal').classList.add('hidden');
                this.currentEditingClient = null;
            }
            
            populateClientForm(client) {
                document.getElementById('client-id').value = client.id;
                document.getElementById('client-name').value = client.name || '';
                document.getElementById('client-company').value = client.company || '';
                document.getElementById('client-email').value = client.email || '';
                document.getElementById('client-phone').value = client.phone || '';
                document.getElementById('client-notes').value = client.notes || '';
            }
            
            handleClientSubmit(e) {
                e.preventDefault();
                
                const clientData = {
                    id: this.currentEditingClient ? this.currentEditingClient.id : this.generateId(),
                    name: document.getElementById('client-name').value,
                    company: document.getElementById('client-company').value,
                    email: document.getElementById('client-email').value,
                    phone: document.getElementById('client-phone').value,
                    notes: document.getElementById('client-notes').value,
                    created_at: this.currentEditingClient ? this.currentEditingClient.created_at : new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                if (!clientData.name.trim()) {
                    alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã¯å¿…é ˆã§ã™');
                    return;
                }
                
                if (this.currentEditingClient) {
                    const index = this.clients.findIndex(c => c.id === clientData.id);
                    this.clients[index] = clientData;
                } else {
                    this.clients.push(clientData);
                }
                
                this.saveData();
                this.closeClientModal();
                this.renderClients();
                
                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚æ›´æ–°
                this.updateAllClientFilters();
            }
            
            deleteClient(clientId) {
                if (confirm('ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                    this.clients = this.clients.filter(c => c.id !== clientId);
                    
                    // é–¢é€£ã™ã‚‹ã‚¿ã‚¹ã‚¯ã®client_idã‚’ã‚¯ãƒªã‚¢
                    this.tasks.forEach(task => {
                        if (task.client_id === clientId) {
                            task.client_id = null;
                        }
                    });
                    
                    this.saveData();
                    this.renderClients();
                    
                    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®é¡§å®¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚‚æ›´æ–°
                    this.updateAllClientFilters();
                }
            }
            
            renderClients() {
                const container = document.getElementById('clients-container');
                
                if (this.clients.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-users text-4xl mb-4"></i>
                            <p class="text-lg">é¡§å®¢ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                            <p class="text-sm">æ–°ã—ã„é¡§å®¢ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                this.clients.forEach(client => {
                    const clientTasks = this.tasks.filter(t => t.client_id === client.id);
                    const completedTasks = clientTasks.filter(t => t.status === 'completed');
                    const totalHours = clientTasks.reduce((sum, task) => sum + (task.actual_hours || 0), 0);
                    
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow';
                    
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-gray-900">${client.name}</h3>
                                ${client.company ? `<p class="text-gray-600 text-sm">${client.company}</p>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button class="p-2 rounded-lg border border-gray-300 hover:bg-gray-50"
                                        onclick="app.openClientModal(app.clients.find(c => c.id === '${client.id}'))" title="ç·¨é›†">
                                    <i class="fas fa-edit text-sm text-gray-600"></i>
                                </button>
                                <button class="p-2 rounded-lg border border-gray-300 hover:bg-gray-50 text-red-600"
                                        onclick="app.deleteClient('${client.id}')" title="å‰Šé™¤">
                                    <i class="fas fa-trash text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm text-gray-600">
                            ${client.email ? `<div><i class="fas fa-envelope mr-2"></i>${client.email}</div>` : ''}
                            ${client.phone ? `<div><i class="fas fa-phone mr-2"></i>${client.phone}</div>` : ''}
                        </div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">${clientTasks.length}</div>
                                    <div class="text-xs text-gray-500">ç·ã‚¿ã‚¹ã‚¯</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600">${completedTasks.length}</div>
                                    <div class="text-xs text-gray-500">å®Œäº†æ¸ˆã¿</div>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-600">${totalHours.toFixed(1)}h</div>
                                    <div class="text-xs text-gray-500">ä½œæ¥­æ™‚é–“</div>
                                </div>
                            </div>
                        </div>
                        
                        ${client.notes ? `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-sm text-gray-600">${client.notes}</p>
                            </div>
                        ` : ''}
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            // ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
            renderReports() {
                this.updateReportStats();
                this.renderCharts();
            }
            
            updateReportStats() {
                const totalTasks = this.tasks.length;
                const completedTasks = this.tasks.filter(t => t.status === 'completed').length;
                const totalHours = this.tasks.reduce((sum, task) => sum + (task.actual_hours || 0), 0);
                const totalClients = this.clients.length;
                
                document.getElementById('total-tasks').textContent = totalTasks;
                document.getElementById('completed-tasks').textContent = completedTasks;
                document.getElementById('total-hours').textContent = `${totalHours.toFixed(1)}h`;
                document.getElementById('total-clients').textContent = totalClients;
            }
            
            renderCharts() {
                this.renderStatusChart();
                this.renderPriorityChart();
                this.renderMonthlyHoursChart();
            }
            
            renderStatusChart() {
                const ctx = document.getElementById('status-chart').getContext('2d');
                
                const statusCounts = {
                    pending: this.tasks.filter(t => t.status === 'pending').length,
                    in_progress: this.tasks.filter(t => t.status === 'in_progress').length,
                    completed: this.tasks.filter(t => t.status === 'completed').length
                };
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æœªç€æ‰‹', 'é€²è¡Œä¸­', 'å®Œäº†'],
                        datasets: [{
                            data: [statusCounts.pending, statusCounts.in_progress, statusCounts.completed],
                            backgroundColor: ['#FEF3C7', '#DBEAFE', '#D1FAE5'],
                            borderColor: ['#F59E0B', '#3B82F6', '#10B981'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
            
            renderPriorityChart() {
                const ctx = document.getElementById('priority-chart').getContext('2d');
                
                const priorityCounts = {
                    high: this.tasks.filter(t => t.priority === 'high').length,
                    medium: this.tasks.filter(t => t.priority === 'medium').length,
                    low: this.tasks.filter(t => t.priority === 'low').length
                };
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['é«˜', 'ä¸­', 'ä½'],
                        datasets: [{
                            label: 'ã‚¿ã‚¹ã‚¯æ•°',
                            data: [priorityCounts.high, priorityCounts.medium, priorityCounts.low],
                            backgroundColor: ['#FEE2E2', '#FED7AA', '#F3F4F6'],
                            borderColor: ['#EF4444', '#F97316', '#6B7280'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            renderMonthlyHoursChart() {
                const ctx = document.getElementById('monthly-hours-chart').getContext('2d');
                
                // éå»6ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                const months = [];
                const hoursData = [];
                const today = new Date();
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                    const monthStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    months.push(`${date.getMonth() + 1}æœˆ`);
                    
                    // ãã®æœˆã«å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯ã®ä½œæ¥­æ™‚é–“ã‚’åˆè¨ˆ
                    const monthHours = this.tasks
                        .filter(task => {
                            if (task.status !== 'completed' || !task.updated_at) return false;
                            const taskMonth = task.updated_at.substring(0, 7);
                            return taskMonth === monthStr;
                        })
                        .reduce((sum, task) => sum + (task.actual_hours || 0), 0);
                    
                    hoursData.push(monthHours);
                }
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'ä½œæ¥­æ™‚é–“',
                            data: hoursData,
                            borderColor: '#3B82F6',
                            backgroundColor: '#DBEAFE',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'æ™‚é–“'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // Google Calendar APIçµ±åˆæ©Ÿèƒ½
            async initializeGoogleCalendarAPI() {
                try {
                    const apiKey = this.settings.googleApiKey;
                    const clientId = this.settings.googleClientId;
                    
                    if (!apiKey || !clientId) {
                        this.updateCalendarStatus('APIã‚­ãƒ¼ã¾ãŸã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                        return;
                    }
                    
                    // Google API ClientåˆæœŸåŒ–
                    await new Promise((resolve) => {
                        if (window.gapi) {
                            gapi.load('client', resolve);
                        } else {
                            this.updateCalendarStatus('Google API Clientã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                        }
                    });
                    
                    await gapi.client.init({
                        apiKey: apiKey,
                        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest']
                    });
                    
                    // Google Identity ServicesåˆæœŸåŒ–
                    if (window.google && window.google.accounts) {
                        this.googleTokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: clientId,
                            scope: 'https://www.googleapis.com/auth/calendar',
                            callback: (tokenResponse) => {
                                this.googleAccessToken = tokenResponse.access_token;
                                gapi.client.setToken({access_token: tokenResponse.access_token});
                                this.updateCalendarStatus('Google Calendarã«æ­£å¸¸ã«æ¥ç¶šã•ã‚Œã¾ã—ãŸ', 'success');
                                document.getElementById('sync-tasks-to-calendar').disabled = false;
                            }
                        });
                    }
                    
                    this.isGoogleCalendarInitialized = true;
                    this.updateCalendarStatus('Google Calendar APIåˆæœŸåŒ–å®Œäº†', 'success');
                    
                } catch (error) {
                    console.error('Google Calendar APIåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateCalendarStatus(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
            
            updateCalendarStatus(message, type) {
                const statusElement = document.getElementById('calendar-status');
                statusElement.textContent = message;
                statusElement.className = `text-sm ${
                    type === 'success' ? 'text-green-600' : 
                    type === 'error' ? 'text-red-600' : 
                    'text-blue-600'
                }`;
            }
            
            async authenticateGoogleCalendar() {
                try {
                    this.saveSettings(); // ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜
                    
                    if (!this.isGoogleCalendarInitialized) {
                        await this.initializeGoogleCalendarAPI();
                    }
                    
                    if (this.googleTokenClient) {
                        this.updateCalendarStatus('èªè¨¼ä¸­...', 'info');
                        this.googleTokenClient.requestAccessToken();
                    } else {
                        this.updateCalendarStatus('Google OAuth2ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                } catch (error) {
                    console.error('Googleèªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
                    this.updateCalendarStatus(`èªè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
            
            async testCalendarConnection() {
                try {
                    if (!this.googleAccessToken) {
                        this.updateCalendarStatus('ã¾ãšGoogleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„', 'error');
                        return;
                    }
                    
                    const calendarId = document.getElementById('calendar-id').value || 'primary';
                    
                    this.updateCalendarStatus('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
                    
                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒ†ã‚¹ãƒˆ
                    const response = await gapi.client.calendar.calendars.get({
                        calendarId: calendarId
                    });
                    
                    if (response.status === 200) {
                        const calendarName = response.result.summary;
                        this.updateCalendarStatus(`æ¥ç¶šæˆåŠŸ: ${calendarName}`, 'success');
                        document.getElementById('sync-tasks-to-calendar').disabled = false;
                    }
                    
                } catch (error) {
                    console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    this.updateCalendarStatus(`æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                }
            }
            
            async syncTasksToCalendar() {
                try {
                    if (!this.googleAccessToken) {
                        this.updateCalendarStatus('Googleèªè¨¼ãŒå¿…è¦ã§ã™', 'error');
                        return;
                    }
                    
                    const calendarId = document.getElementById('calendar-id').value || 'primary';
                    const pendingTasks = this.tasks.filter(task => task.status !== 'completed');
                    
                    this.updateCalendarStatus(`${pendingTasks.length}å€‹ã®ã‚¿ã‚¹ã‚¯ã‚’åŒæœŸä¸­...`, 'info');
                    
                    let syncedCount = 0;
                    let errorCount = 0;
                    
                    for (const task of pendingTasks) {
                        try {
                            // ã‚¿ã‚¹ã‚¯ã®æœŸé™æ—¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ä½œæˆ
                            const eventResource = {
                                summary: `ğŸ“‹ ${task.title}`,
                                description: this.createEventDescription(task),
                                start: {
                                    date: task.deadline
                                },
                                end: {
                                    date: task.deadline
                                },
                                reminders: {
                                    useDefault: false,
                                    overrides: [
                                        {method: 'popup', minutes: 60},
                                        {method: 'popup', minutes: 10}
                                    ]
                                },
                                extendedProperties: {
                                    private: {
                                        taskflow_task_id: task.id,
                                        taskflow_sync: 'true'
                                    }
                                }
                            };
                            
                            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
                            const existingEvents = await gapi.client.calendar.events.list({
                                calendarId: calendarId,
                                privateExtendedProperty: `taskflow_task_id=${task.id}`
                            });
                            
                            if (existingEvents.result.items.length > 0) {
                                // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
                                const eventId = existingEvents.result.items[0].id;
                                await gapi.client.calendar.events.update({
                                    calendarId: calendarId,
                                    eventId: eventId,
                                    resource: eventResource
                                });
                            } else {
                                // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ
                                await gapi.client.calendar.events.insert({
                                    calendarId: calendarId,
                                    resource: eventResource
                                });
                            }
                            
                            syncedCount++;
                            
                        } catch (taskError) {
                            console.error(`ã‚¿ã‚¹ã‚¯ ${task.title} ã®åŒæœŸã‚¨ãƒ©ãƒ¼:`, taskError);
                            errorCount++;
                        }
                    }
                    
                    const resultMessage = `åŒæœŸå®Œäº†: ${syncedCount}å€‹æˆåŠŸ`;
                    const errorMessage = errorCount > 0 ? `, ${errorCount}å€‹ã‚¨ãƒ©ãƒ¼` : '';
                    this.updateCalendarStatus(resultMessage + errorMessage, syncedCount > 0 ? 'success' : 'error');
                    
                } catch (error) {
                    console.error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                    this.updateCalendarStatus(`åŒæœŸã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }
            
            createEventDescription(task) {
                const client = task.client_id ? this.clients.find(c => c.id === task.client_id) : null;
                const priorityText = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' };
                
                let description = `TaskFlow Pro ã‹ã‚‰åŒæœŸ\n\n`;
                description += `å„ªå…ˆåº¦: ${priorityText[task.priority]}\n`;
                description += `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${task.status === 'pending' ? 'æœªç€æ‰‹' : task.status === 'in_progress' ? 'é€²è¡Œä¸­' : 'å®Œäº†'}\n`;
                
                if (client) {
                    description += `é¡§å®¢: ${client.name}`;
                    if (client.company) description += ` (${client.company})`;
                    description += `\n`;
                }
                
                if (task.estimated_hours > 0) {
                    description += `äºˆæƒ³ä½œæ¥­æ™‚é–“: ${task.estimated_hours}æ™‚é–“\n`;
                }
                
                if (task.description) {
                    description += `\nèª¬æ˜:\n${task.description}`;
                }
                
                return description;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
            exportData() {
                const data = {
                    tasks: this.tasks,
                    clients: this.clients,
                    subtasks: this.subtasks,
                    timeLogs: this.timeLogs,
                    settings: this.settings,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `taskflow-export-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
            
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        this.showImportOptions(data);
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    }
                };
                reader.readAsText(file);
                
                // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            }
            
            showImportOptions(importData) {
                // ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–¹å¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">
                            <i class="fas fa-upload mr-2 text-blue-600"></i>
                            ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ–¹å¼ã‚’é¸æŠ
                        </h3>
                        
                        <div class="space-y-4 mb-6">
                            <div class="border border-gray-200 rounded-lg p-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="import-mode" value="merge" class="mr-3" checked>
                                    <div>
                                        <div class="font-medium text-green-700">ğŸ“ˆ å·®åˆ†è¿½åŠ ï¼ˆæ¨å¥¨ï¼‰</div>
                                        <div class="text-sm text-gray-600">é‡è¤‡ã—ã¦ã„ãªã„æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã®ã¿è¿½åŠ </div>
                                    </div>
                                </label>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg p-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="import-mode" value="replace" class="mr-3">
                                    <div>
                                        <div class="font-medium text-red-700">ğŸ”„ å®Œå…¨ç½®ãæ›ãˆ</div>
                                        <div class="text-sm text-gray-600">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ç½®ãæ›ãˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰</div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-4">
                            <div class="text-sm text-blue-800">
                                <strong>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</strong><br>
                                ã‚¿ã‚¹ã‚¯: ${importData.tasks?.length || 0}ä»¶ã€
                                é¡§å®¢: ${importData.clients?.length || 0}ä»¶ã€
                                ã‚µãƒ–ã‚¿ã‚¹ã‚¯: ${importData.subtasks?.length || 0}ä»¶
                            </div>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button id="import-cancel-btn" 
                                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                            <button id="import-execute-btn" 
                                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                                å®Ÿè¡Œ
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
                modal.querySelector('#import-cancel-btn').addEventListener('click', () => {
                    modal.remove();
                });
                
                modal.querySelector('#import-execute-btn').addEventListener('click', () => {
                    const mode = modal.querySelector('input[name="import-mode"]:checked').value;
                    if (mode === 'merge') {
                        this.mergeImportData(importData);
                    } else {
                        this.replaceImportData(importData);
                    }
                    modal.remove();
                });
            }
            
            mergeImportData(importData) {
                let stats = {
                    tasksAdded: 0,
                    clientsAdded: 0,
                    subtasksAdded: 0,
                    timeLogsAdded: 0,
                    duplicatesSkipped: 0
                };
                
                // ã‚¿ã‚¹ã‚¯ã®å·®åˆ†è¿½åŠ 
                if (importData.tasks) {
                    importData.tasks.forEach(newTask => {
                        const exists = this.tasks.find(task => 
                            task.id === newTask.id || 
                            (task.title === newTask.title && task.deadline === newTask.deadline)
                        );
                        if (!exists) {
                            // æ–°ã—ã„IDã‚’ç”Ÿæˆï¼ˆæ—¢å­˜IDã¨ã®é‡è¤‡ã‚’é¿ã‘ã‚‹ï¼‰
                            if (!newTask.id || this.tasks.find(t => t.id === newTask.id)) {
                                newTask.id = 'task_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                            this.tasks.push(newTask);
                            stats.tasksAdded++;
                        } else {
                            stats.duplicatesSkipped++;
                        }
                    });
                }
                
                // é¡§å®¢ã®å·®åˆ†è¿½åŠ 
                if (importData.clients) {
                    importData.clients.forEach(newClient => {
                        const exists = this.clients.find(client => 
                            client.id === newClient.id || 
                            (client.name === newClient.name && client.company === newClient.company)
                        );
                        if (!exists) {
                            if (!newClient.id || this.clients.find(c => c.id === newClient.id)) {
                                newClient.id = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                            this.clients.push(newClient);
                            stats.clientsAdded++;
                        } else {
                            stats.duplicatesSkipped++;
                        }
                    });
                }
                
                // ã‚µãƒ–ã‚¿ã‚¹ã‚¯ã®å·®åˆ†è¿½åŠ 
                if (importData.subtasks) {
                    importData.subtasks.forEach(newSubtask => {
                        const exists = this.subtasks.find(subtask => 
                            subtask.id === newSubtask.id ||
                            (subtask.parent_task_id === newSubtask.parent_task_id && subtask.title === newSubtask.title)
                        );
                        if (!exists) {
                            if (!newSubtask.id || this.subtasks.find(s => s.id === newSubtask.id)) {
                                newSubtask.id = 'subtask_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                            this.subtasks.push(newSubtask);
                            stats.subtasksAdded++;
                        } else {
                            stats.duplicatesSkipped++;
                        }
                    });
                }
                
                // æ™‚é–“ãƒ­ã‚°ã®å·®åˆ†è¿½åŠ 
                if (importData.timeLogs) {
                    importData.timeLogs.forEach(newLog => {
                        const exists = this.timeLogs.find(log => 
                            log.id === newLog.id ||
                            (log.task_id === newLog.task_id && log.start_time === newLog.start_time)
                        );
                        if (!exists) {
                            if (!newLog.id || this.timeLogs.find(l => l.id === newLog.id)) {
                                newLog.id = 'timelog_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }
                            this.timeLogs.push(newLog);
                            stats.timeLogsAdded++;
                        } else {
                            stats.duplicatesSkipped++;
                        }
                    });
                }
                
                // è¨­å®šã¯é‡è¤‡ãƒã‚§ãƒƒã‚¯ã›ãšãƒãƒ¼ã‚¸
                if (importData.settings) {
                    this.settings = { ...this.settings, ...importData.settings };
                }
                
                this.saveData();
                this.loadSettings();
                this.renderTasks();
                this.renderClients();
                
                // è©³ç´°ãªçµæœè¡¨ç¤º
                const message = `ğŸ“ˆ å·®åˆ†ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†ï¼

âœ… è¿½åŠ ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿:
â€¢ ã‚¿ã‚¹ã‚¯: ${stats.tasksAdded}ä»¶
â€¢ é¡§å®¢: ${stats.clientsAdded}ä»¶  
â€¢ ã‚µãƒ–ã‚¿ã‚¹ã‚¯: ${stats.subtasksAdded}ä»¶
â€¢ æ™‚é–“ãƒ­ã‚°: ${stats.timeLogsAdded}ä»¶

â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé‡è¤‡ï¼‰: ${stats.duplicatesSkipped}ä»¶`;
                
                alert(message);
                console.log('ğŸ“Š ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµ±è¨ˆ:', stats);
            }
            
            replaceImportData(importData) {
                if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    return;
                }
                
                this.tasks = importData.tasks || [];
                this.clients = importData.clients || [];
                this.subtasks = importData.subtasks || [];
                this.timeLogs = importData.timeLogs || [];
                this.settings = importData.settings || {};
                
                this.saveData();
                this.loadSettings();
                this.renderTasks();
                this.renderClients();
                
                alert('ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨ç½®ãæ›ãˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            }
            
            clearAllData() {
                if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                    if (confirm('æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                        this.tasks = [];
                        this.clients = [];
                        this.subtasks = [];
                        this.timeLogs = [];
                        this.settings = {};
                        
                        localStorage.removeItem('taskflow_tasks');
                        localStorage.removeItem('taskflow_clients');
                        localStorage.removeItem('taskflow_subtasks');
                        localStorage.removeItem('taskflow_time_logs');
                        localStorage.removeItem('taskflow_settings');
                        
                        this.renderTasks();
                        this.loadSettings();
                        
                        alert('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                    }
                }
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        window.app = new TaskFlowApp();
    </script>
</body>
</html>